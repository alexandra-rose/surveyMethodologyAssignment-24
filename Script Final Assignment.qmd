---
title: "Final Assignment - Explaining support for transgender rights across Europe"
author: Frederick Peña, Alexandra Salo and Sofia Villamil
format: html
editor: visual
editor_options: 
  chunk_output_type: inline
---

## Final Assignment

## Libraries

```{r}
rm(list = ls())

```

```{r, results='hide'}
library(haven)
library(readr)
library(haven) 
library(writexl)
library(sjlabelled)
library(tidyverse)
library(corrplot)
library(dplyr)
library(gmodels)
library(scales)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(ggplot2)
library(leaflet)
library(tidyverse)
library(MASS)
library(caret)
library(plotly)
library(car)
library(caret)
library(rpart)
library(rpart.plot)
library(lme4)
library(pROC)
library(caret)
library(pdp)
library(Matrix)
library(lattice)
```

## Data

```{r}
data <- read_dta("Data/ZA7575.dta")
```

## DATA CLEANING

Cleaning specific variables to determine which are the more important once for our analysis.

**ID**

```{r}
data_cleaning_1 <- data %>%
  select(
         -c(studyno1, studyno2, doi, version, edition,survey))

data_cleaning_2 <- data_cleaning_1 %>% 
  select(serialid, everything())
```

**Country ID**

```{r}
# creating a variable for country name to be more organized
data_cleaning_2$country_name <- NA
data_cleaning_2$country_name[data_cleaning_2$q1_1 == 1] <- 'Belgium'
data_cleaning_2$country_name[data_cleaning_2$q1_2 == 1] <- 'Denmark'
data_cleaning_2$country_name[data_cleaning_2$q1_3 == 1] <- 'Germany'
data_cleaning_2$country_name[data_cleaning_2$q1_4 == 1] <- 'Greece'
data_cleaning_2$country_name[data_cleaning_2$q1_5 == 1] <- 'Spain'
data_cleaning_2$country_name[data_cleaning_2$q1_6 == 1] <- 'France'
data_cleaning_2$country_name[data_cleaning_2$q1_7 == 1] <- 'Ireland'
data_cleaning_2$country_name[data_cleaning_2$q1_8 == 1] <- 'Italy'
data_cleaning_2$country_name[data_cleaning_2$q1_9 == 1] <- 'Luxembourg'
data_cleaning_2$country_name[data_cleaning_2$q1_10 == 1] <- 'Netherlands'
data_cleaning_2$country_name[data_cleaning_2$q1_11 == 1] <- 'Portugal'
data_cleaning_2$country_name[data_cleaning_2$q1_12 == 1] <- 'United Kingdom'
data_cleaning_2$country_name[data_cleaning_2$q1_13 == 1] <- 'Austria'
data_cleaning_2$country_name[data_cleaning_2$q1_14 == 1] <- 'Sweden'
data_cleaning_2$country_name[data_cleaning_2$q1_15 == 1] <- 'Finland'
data_cleaning_2$country_name[data_cleaning_2$q1_16 == 1] <- 'Cyprus'
data_cleaning_2$country_name[data_cleaning_2$q1_17 == 1] <- 'Czech Republic'
data_cleaning_2$country_name[data_cleaning_2$q1_18 == 1] <- 'Estonia'
data_cleaning_2$country_name[data_cleaning_2$q1_19 == 1] <- 'Hungary'
data_cleaning_2$country_name[data_cleaning_2$q1_20 == 1] <- 'Latvia'
data_cleaning_2$country_name[data_cleaning_2$q1_21 == 1] <- 'Lithuania'
data_cleaning_2$country_name[data_cleaning_2$q1_22 == 1] <- 'Malta'
data_cleaning_2$country_name[data_cleaning_2$q1_23 == 1] <- 'Poland'
data_cleaning_2$country_name[data_cleaning_2$q1_24 == 1] <- 'Slovakia'
data_cleaning_2$country_name[data_cleaning_2$q1_25 == 1] <- 'Slovenia'
data_cleaning_2$country_name[data_cleaning_2$q1_26 == 1] <- 'Bulgaria'
data_cleaning_2$country_name[data_cleaning_2$q1_27 == 1] <- 'Romania'
data_cleaning_2$country_name[data_cleaning_2$q1_28 == 1] <- 'Croatia'
data_cleaning_2$country_name[data_cleaning_2$q1_29 == 1] <- 'Other countries'
data_cleaning_2$country_name[data_cleaning_2$q1_30 == 1] <- 'DK'
```

```{r}
# factor
data_cleaning_2$country_name <- factor(data_cleaning_2$country_name)

```

### Extra Country Level Variables

**Legal variable**

We believe that the data was missing some variables related to the legality aspect in a country level so we found this data.

```{r}
Data_Extra_by_Country <- read_delim("data_extra_by_Country.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

all_na_columns <- sapply(Data_Extra_by_Country, function(x) all(is.na(x)))

# There are columns with all NA due to the filtering in stata done before for the year 2019.

columns_to_remove <- names(Data_Extra_by_Country)[all_na_columns]

# remove the columns
Data_Extra_by_Country <- Data_Extra_by_Country[, !all_na_columns]
Data_Extra_by_Country <- Data_Extra_by_Country[, !names(Data_Extra_by_Country) %in% "e_polity2"]

# dataframe of all the variables for 2019 related to legal or political views of most of the countries in the world
```

Looking into the extra data set

```{r}
Data_Extra_by_Country$country_name <- factor(Data_Extra_by_Country$country_name)
```

The variables chosen are the following:

```{r}
Data_Extra_by_Country <- Data_Extra_by_Country %>% 
  select(country_name,adp_general)
```

```{r}
merged_df_1 <- merge(data_cleaning_2, Data_Extra_by_Country, by = "country_name", all.x = TRUE)
```

**Economic Variables**

The economic variables we choose were Unemployment and GDP per capita.

The data was attained from the World Bank.

```{r}
Eco_Extra_Data <- read_delim("Eco Extra Data.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) 
```

```{r}
merged_df <- merge(merged_df_1, Eco_Extra_Data, by = "country_name", all.x = TRUE)
```

## EXPLAINING CROSS-COUNTRY DIFFERENCES

In this section, we will try to reveal predictors of support or lack thereof for transgender rights, specifically the ability to change civic documents. During this step, we will oscillate between individual-level and country-level analyses, developing our thoughts based on a previous literature review during which we identified key predictors explaining support of transgender rights. (see Campbell et al., 2019; Earl et al., 2020; Flores, 2015; Flores et al., 2016; Harrison and Michelson, 2019; Norton and Herek, 2013)

## Descriptive Analysis 

### Gender

First, we focus on gender as a predictor of support for transgender rights.

We visually show that men, in line with the literature, post lower rates in support and higher rates in rejection than women.

```{r}

df_descriptive <- merged_df

df_descriptive$qc19_multinominal <- factor(df_descriptive$qc19, levels = c(1, 2, 3),labels = c("Yes", "No", "Don't know"))

qc19labels <- c("Yes", "No", "Don't know")
names(qc19labels) <- c(1, 2, 3)

df_descriptive |>
  mutate(d10 = as.factor(d10),
         qc19_n = as.numeric(qc19),
         qc19 = as.factor(qc19)) |> 
  group_by(d10) |> 
  mutate(gsumqc19 = sum(qc19_n)) |> 
  ungroup() |> 
  group_by(qc19, d10) |> 
  mutate(gshare19 = (sum(qc19_n)/gsumqc19)*100) |> 
  ungroup() |> 
  ggplot(aes(x = qc19_multinominal, y = gshare19, fill = d10))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", gshare19))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  labs(title = "Do you think that transgender persons should be able to change\ntheir civil documents to match their inner gender identity?",
y = NULL,
x = NULL,
caption = "Source: Eurobarometer 91.4") +
  scale_fill_manual(labels = c("Men", "Women"), values = c("blue", "red")) +
  theme_minimal() +
  theme(legend.position = "bottom") +  # Adjust legend position
  guides(fill = guide_legend(title = NULL))  # Hide legend title


```

### Binary conception of gender

To operationalize the binary conception of gender we draw on the variable **'qc20'** for which respondents had to giver information about their believes regarding a third gender option on legal documents.

```{r}
df_descriptive$qc20_multinominal <- factor(df_descriptive$qc20, levels = c(1, 2, 3),labels = c("Yes", "No", "Don't know"))

CrossTable(df_descriptive$qc19_multinominal, df_descriptive$qc20_multinominal, 
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Since the p-value is much smaller than the conventional significance level of 0.05, we reject the null hypothesis. This suggests that there is a significant association between the variables **`qc19`** and **`qc20`**.

When looking at the cross table, we can identify a very high convergence of people against a third gender option and rejecting the ability for transgender to adjust their civic documents, while the inverse is true for individuals who support the same measure singificantly.

```{r}
plot_binary_1 <-
  df_descriptive |> 
  group_by(country_name) |> 
  summarise(share_no = mean(qc20 == 2, na.rm = TRUE)*100) |> 
  arrange(desc(share_no)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share_no)) +
  geom_col(fill = "red") +
  labs(x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share_no))),vjust = -0.5, size = 2)  +
  annotate("text", x = 9.5, y = 70, 
           label = "Share of 'No' responses to qc19:\nDo you think that transgender persons should be able to change\ntheir civil documents to match their inner gender identity?",
           hjust = 0, vjust = 0.5, size = 3, color = "black") +
  geom_rect(aes(xmin = 9.3, xmax = 24.3, 
                ymin = 62, ymax = 77),
                fill = "transparent", color = "black", linewidth = 1)

plot_binary_2 <- 
  df_descriptive |> 
  group_by(country_name) |> 
  summarise(share_no = mean(qc19 == 2, na.rm = TRUE)*100) |> 
  arrange(desc(share_no)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share_no)) +
  geom_col(fill = "red") +
  labs(x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 90, hjust= 0),
        plot.margin = margin(-10, 0, 0, 0)) +
  scale_x_discrete(position = "top") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share_no))), vjust = -0.5, size = 2)  +
  annotate("text", x = 10, y = 65, 
           label = "Share of 'No' responses to qc20:\nDo you believe that official documents, like passports and birth\ncertificates, should have a third option, such as X or O (other)\nbeside male (M) and female (F)for those persons who do not\nidentify as female and male?",
           hjust = 0, vjust = 0.5, size = 3, color = "black") +
  geom_rect(aes(xmin = 9.8, xmax = 24.6, 
                ymin = 53, ymax = 76),
                fill = "transparent", color = "black", linewidth = 1)
```

```{r}
#| echo: false
#| layout-ncol: 1

plot_binary_1
plot_binary_2
```

The plots show that this high convergence can also be seen on the country level, where countries in which the share of people opposing a third gender option almost mirrors that of the share who oppose more expanded transgender rights when ranked.

To verify this association statistically, the Spearman rank test is used as the country-level proportions are not normally distributed. The Spearman rank test reports a very strong positive relationship between the two variables supporting the previous assertion that the acceptance of a third gender differentiates countries concerning their average approval of the civil document alteration for transgender people

```{r}
df_country_1 <- 
  df_descriptive |>
  group_by(country_name) |> 
  summarize(
    prop_gndr_bin = (sum(qc20_multinominal == "Yes") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_1$prop_gndr_bin, df_country_1$prop_qc19_yes, method = "spearman")
```

### Political ideology

In the following we turn our attention to the political ideology of individuals.

```{r}
df_descriptive$d1_ordinal <- factor(df_descriptive$d1, levels = c(1, 2, 3, 4 , 5, 6, 7, 8, 9, 10, 97, 98),labels = c("Left", "2", "3", "4", "5", "6", "7", "8", "9", "Right", "Non-response", "Don't know"))

CrossTable(df_descriptive$d1_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Upfront, it is important to note that 25% of respondents chose option 5, which represents the exact middle ground.

Nonetheless there are surprising results. While the inherent idea is upheld that a greater share of more left-leaning people are in favor of transgender rights, the difference to very right-leaning people is not that great - 60% in favor - 30% against for left leaning individuals vs. 43% in favor -45% against for right leaning individuals.

Of course, we have to consider common limitations of self-reporting left-right scales such as accuracy. Additionally, there is a significant amount of information hidden in the 'non-response' and 'Don't know' groups of political ideology as they have greater 'Don't know' rates for our dependent variable.

All in all, we can still see a significant association, which, however, is maybe not as strong as suspected.

The results are visualized below.

```{r}

df_descriptive |> 
  mutate(d1_bin = case_when(
    d1 < 4 ~ "Left",
    d1 < 8 ~ "Middle",
    d1 < 11 ~ "Right",
    TRUE ~ "DK/Refusal"
  )) |> 
  mutate(d1_bin = fct_relevel(d1_bin, "DK/Refusal", after = Inf)) |> 
  group_by(d1_bin, qc19_multinominal) |> 
  summarise(count = n()) |> 
  group_by(d1_bin) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = d1_bin, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by political ideology",
       x = "Political Ideology",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Religiosity

Moving on the religious affiliation, we had to recode the variable slightly due to low numbers for certain categories (see below).

```{r}
df_descriptive <-
  df_descriptive |> 
  mutate(sd3_cat = case_when(sd3 == 1 ~ "Catholic",
                             sd3 == 2 ~ "Orthodox Christian",
                             sd3 == 3 ~ "Protestant",
                             sd3 == 4 ~ "Other Christian",
                             sd3 == 5 ~ "Jewish",
                             sd3 < 9 ~ "Muslim", 
                             sd3 < 12 ~ "Other",
                             sd3 < 14 ~ "Atheist | Agnostic",
                             sd3 == 14 ~ "Other",
                             sd3 > 14 ~ "Don't know | Refusal")) 

CrossTable(df_descriptive$sd3_cat, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Almost immediately, we see very low counts for Jewish, Muslim, Other and Other Christian. This is visualized by the polit below.

```{r}
df_descriptive |> 
  mutate(sd3_cat = fct_relevel(sd3_cat, "Don't know | Refusal", after = Inf)) |> 
  ggplot(aes(x = sd3_cat)) +
  geom_bar(fill = "black", color = "black", alpha = 0.5) +
  labs(title = "Frequency by religious affiliation",
       x = "",
       y = "Absolutec count",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Nonetheless, there are some general takeaways. Religiosity itself is not associated with lower levels of support for transgender rights, as Protestants as much as Atheists and Agnostics report high levels of support. Among Catholics, support is higher as well relatively, but it is less strong. Orthodox Christian present strong outlier with being strongly against transgender rights.

Below we extrapolate this to the country level, showing that there is a high convergence of majoritarian Christian orthodox countries and the rejection of transgender rights.

```{r}
df_descriptive |> 
  group_by(country_name) |> 
  summarise(share = mean(sd3_cat == "Orthodox Christian", na.rm = TRUE)*100) |> 
  arrange(desc(share)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share)) +
  geom_col(fill = "red") +
  labs(title = "Share of Orthodox Christians", 
       x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share))),vjust = -0.5, size = 2)
```

### Contact

Next, we looked at interpersonal contact with transgender individuals as a possible predictor.

```{r}
df_descriptive <-
  df_descriptive |> 
  mutate(
    sd1_7_NA = car::recode(sd1_7, "1=1; 2=0; 3=NA; 4=2"),
    sd1_7_multinomial = factor(sd1_7_NA, levels = c(0, 1, 2), labels = c("No", "Yes", "Don't know"))
  )

CrossTable(df_descriptive$sd1_7_multinomial, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Again the p-value is below 0.05 rendering the association statistically significant.

First off, the majority of people did not have contact with a transgender person. Nonetheless, there is a clear tendency on the individual level that among those that have not had contact with a transgender person the approval is relatively lower as for those who have had the margin is very clear (76% vs 18%). However, contact is associated rather with approval. Not having had contact is not associated with being predominantly against transgender rights, but rather is associated with lower approval rates.

We visualize this below.

```{r}
df_descriptive|> 
  drop_na(sd1_7_multinomial) |> 
  group_by(sd1_7_multinomial, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd1_7_multinomial) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd1_7_multinomial, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by previous conatct with transgender person",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Age

For age we use ANOVA to seek out differences between those who responded 'yes', 'no', don't know' by age.

```{r}
anova <- aov(d11 ~ qc19_multinominal, data = df_descriptive)
summary(anova)
```

The low p-value lets us reject the null hypothesis meaning there is a statistically significant difference between at least two groups.

When visualizing group difference as below by using boxplots, we see that the most pronounced difference is between those saying 'yes' and those stating 'don't know'. With the latter group being older in comparison. This implies there is valuable information from particularly older people missing.

```{r}
ggplot(df_descriptive, aes(x = qc19_multinominal, y = d11, fill = "red")) +
  geom_boxplot(color = "red") +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by age",
       y = "Age",
       x = "Support",
       caption = "Source: Eurobarometer 91.4") +
  theme(legend.position = "none")
```

Concerning the difference between 'yes' and 'no', those reporting the former are generally a bit younger. To check this assumption we employ a correlation to look at strength and direction of the association while differentiating only between 'yes' and 'no'. As suggested above, the association is negative suggesting an age-based association as suggested above as a one year increase in age decreases approval.

```{r}
df_cor_age <- 
  df_descriptive |> 
  select(qc19, d11) |> 
  filter(qc19 < 3) |> # filtering out everything besides 1 and 2
  mutate(qc19 = ifelse(qc19 == 2, 0, qc19)) # Assigning 2 the number 0 for logical interpretation

cor(df_cor_age$d11, df_cor_age$qc19)
```

### Awareness

To operationalize awareness, we draw on a variable asking respondents to report how wide spread, according to them discrimination against transgender indivduals is in their own country.

```{r}
df_descriptive$qc1_8_ordinal <- factor(df_descriptive$qc1_8, levels = c(1, 2, 3, 4 , 5, 6),labels = c("Very wide spread", "Fairly wide spread", "Fairly rare", "Very rare", "Nonexistent
", "DK"))

CrossTable(df_descriptive$qc1_8_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Again, the low p-value lets us very confidently state that there is a statistically significant relationship between the variables. Among those reporting transgender people face very or fairly wide spread discrimination, the relative support for the possibility to change civil documents is greater than for those stating it is fairly rare, while among those reporting it is very rare the share between supporters and opponents is balanced.

This insinuates that while there is a clear association between more awareness and greater support for transgender rights, the inverse is not represented in our data, although individuals stating discrimination against transgender individuals is non-existent show a slightly inverted association.

This is also visualized below:

```{r}
df_descriptive|> 
  drop_na(qc1_8_ordinal) |> 
  group_by(qc1_8_ordinal, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(qc1_8_ordinal) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = qc1_8_ordinal, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

We also investigate this relationship on the country-level.

The plot below shows that countries which have a higher share of approval of transgender rights are found rather towards the higher end of the ranked graph plotting the share of respondents (by country) reporting fairly or very widespread discrimination against transgender individuals.

```{r}
df_descriptive |> 
  mutate(qc1_8_ordinal = case_when(
    qc1_8_ordinal == "Very wide spread" ~ "Very or fairly wide spread",
    qc1_8_ordinal == "Fairly wide spread" ~ "Very or fairly wide spread",
    TRUE ~ qc1_8_ordinal
  )) |>
  group_by(country_name) |> 
  summarise(share = mean(qc1_8_ordinal == "Very or fairly wide spread", na.rm = TRUE)*100) |> 
  arrange(desc(share)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share)) +
  geom_col(fill = "red") +
  labs(title = "Share of respondents perceiving discrimination against transgender people\nto be very of fairly wide spread", 
       x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share))),vjust = -0.5, size = 2)
```

To further investigate the country-level differences, the association of the proportion of individuals aware of discrimination per country and the proportion of individuals in favor of the ability of transgender people to change their civil documents is investigated. Again, because the variables are non-normally distributed, we use the Spearman rank test. The test shows a moderately strong relationship between awareness of discrimination faced by transgender people on the country-level insinuating that in countries with greater awareness there is greater support for transgender rights.

```{r}
df_country_2 <-
  df_descriptive |> 
  mutate(qc1_8_ordinal = case_when(
    qc1_8_ordinal == "Very wide spread" ~ "Very or fairly wide spread",
    qc1_8_ordinal == "Fairly wide spread" ~ "Very or fairly wide spread",
    TRUE ~ qc1_8_ordinal
  )) |> 
  group_by(country_name) |> 
  summarize(
    prop_dis_wide = (sum(qc1_8_ordinal == "Very or fairly wide spread") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_2$prop_dis_wide, df_country_2$prop_qc19_yes, method = "spearman")
```

### Solidarity among minority groups

We now investigate, whethere there is solidarity between minority groups.

```{r}
df_descriptive <- 
  df_descriptive |>  
  mutate(
    sd2t = factor(sd2t, levels = c(0, 1), labels = c("Not mentioned", "Yes"))
  )
```

As the subsequent plot demonstrates, there is no general solidarity among minority group expressed by a greater support for transgender people than among individuals without any minority-background.

```{r}
df_descriptive|> 
  drop_na(sd2t) |> 
  group_by(sd2t, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd2t) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd2t, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

We therefore, focus only on people self-identifying as part of a sexual minority. Support is much greater among people who themselves are a sexual minority. As such, people with similar experiences as transgender people are more likely to support transgender rights.

```{r}
df_descriptive <- 
  df_descriptive |>  
  mutate(
    sd2_5 = factor(sd2_5, levels = c(0, 1), labels = c("Not mentioned", "Yes"))
  )


df_descriptive|> 
  drop_na(sd2_5) |> 
  group_by(sd2_5, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd2_5) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd2_5, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Education

We now turn our focus to the age when leaving and completing formal education.

```{r}
df_descriptive <- 
  df_descriptive |> 
  mutate(d8 = case_when(d8 < 98 ~ d8,
                        TRUE ~ NA)) # turning don't know and refusal into NA to keep continuous character of the variable - imputed later


ggplot(df_descriptive, aes(x = qc19_multinominal, y = d8, fill = "red")) +
  geom_boxplot(color = "red") +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by age",
       y = "Age when leaving formal education",
       x = "Support",
       caption = "Source: Eurobarometer 91.4") +
  theme(legend.position = "none")

```

We first investigate difference by employing a boxplot graph differentiating between 'yes', 'no', and 'don't know' respondents with the former reporting a slightly higher age as their mode (highest frequency).

The ANOVA analysis supports the claim, as there are at least two groups statistically significantly different from one another.

```{r}
anova <- aov(d8 ~ qc19_multinominal, data = df_descriptive)
summary(anova)
```

```{r}
df_cor_age <- df_descriptive |> 
  select(qc19, d8) |> 
  filter(qc19 %in% c(1, 2)) |>   
  mutate(qc19 = as.numeric(qc19 == 1)) 

cor(df_cor_age$d8, df_cor_age$qc19, use = "complete.obs")

```

The correlation shows there is a very weak association in favor of the literature's case that being more educated is associated with an increased support of transgender rights.

### The economic situation

We operationalize the respondent's current economic situation by a variable inquiring if, during the last twelve months, would the respondent would say they had difficulties to pay their bills at the end of the mont.

```{r}
df_descriptive <- 
  df_descriptive |> 
  mutate(
    d60 = car::recode(d60, "4=NA"),
    d60_ordinal = factor(d60, levels = c(1, 2, 3), labels = c("Most of the time", "From time to time", "Almost never/ never"))
  )

CrossTable(df_descriptive$d60_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Agains, we can reject the null hypothesis implying a statistically significant association. Following the literature, among those who never or almost never had difficulties to pay their bills at the end of the month, the support for the possibility of transgender people to alter their gender in their civic documents is markedly higher.

This difference is visualized by the graph below:

```{r}
df_descriptive|> 
  drop_na(d60_ordinal) |> 
  group_by(d60_ordinal, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(d60_ordinal) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = d60_ordinal, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by times having difficulties to pay the bills in last 12 months",
       x = "Having difficulties to pay the bills in last 12 months",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Support for LGB rights

Following we consider support for equal rights for lesbian, gay, and bisexual (LGB) individuals as a possible predictor.

```{r}
df_descriptive <- 
  df_descriptive |> 
  mutate(
    qc15_1_ordinal = factor(qc15_1, levels = c(1, 2, 3, 4, 5), labels = c("Totally agree", "Tend to agree", "Tend to disagree", "Totally disagree", "Don't know"))
  )

CrossTable(df_descriptive$qc15_1_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

The p-value indicates statistical significance concerning the association between the two variables. As may be expected, among those disagreeing that people part of the LGB community should have equal rights the support is very low and the rejection of the possibility. Rejection is almost as pronounced as the support regarding transgender people's ability to change their gender identification of those who totally agree people of the LGB community should have the same rights. As such, we find a 'two-way association'.

We again extrapolate to the country level.

```{r}
df_country_3 <- 
  df_descriptive |>
  mutate(qc15_1_ordinal = case_when(
    qc15_1_ordinal == "Totally agree" ~ "Totally or tend to agree",
    qc15_1_ordinal == "Tend to agree" ~ "Totally or tend to agree",
    TRUE ~ qc15_1_ordinal
  )) |> 
  group_by(country_name) |> 
  summarize(
    prop_lgb_yes = (sum(qc15_1_ordinal == "Totally or tend to agree") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_3$prop_lgb_yes, df_country_3$prop_qc19_yes, method = "spearman")
```

We find a very strong association on the country level indicating that most likely countries where there is greater support for the legal equality for LGB people also post higher support rates for the adoption of legislation allowing transgender people to change their gender in civic documents. While this only captures the support direction, As outlined above, a similar strength may be expected for the revers association.

### Rural vs. urban

Returning to the individual level, we turn our attention to the rural - urban divide.

```{r}
df_descriptive$d25_multinominal <- factor(df_descriptive$d25, labels = c("Rural area", "Small and middle sized town", "Large town", "Don't know"))

# levels = c(1, 2, 3)

CrossTable(df_descriptive$d25_multinominal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Again, the association between the variables is statistically significant. We find that rural area respondents report a lower support and higher rejection than respondents from urban areas.

However, as can be seen below, this difference is not very pronounced.

```{r}
df_descriptive|> 
  drop_na(d25_multinominal) |> 
  filter(d25_multinominal != "Don't know") |> 
  group_by(d25_multinominal, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(d25_multinominal) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = d25_multinominal, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by times type of residence of respondent",
       x = "Place of residence in...",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Legal protections for the transgender community

Turning to the country-level again, to observe if there is are general legal protections across various countries within our data set, an interactive map is developed.

```{r}
df <- df_descriptive %>% 
  select(country_name, adp_general)
df$country_name <- as.character(df$country_name)

df_unique <- df %>%
  group_by(country_name) %>%
  summarise(adp_general = max(adp_general)) %>%
  ungroup()

europe_map <- ne_countries(scale = "medium", continent = "europe", returnclass = "sf")

df_joined <- left_join(europe_map, df_unique, by = c("sovereignt" = "country_name"))

```

```{r}
df_joined$status <- case_when(
  df_joined$adp_general == 1 ~ "General",
  df_joined$adp_general == 0 ~ "None",
  TRUE ~ "No Information"
)

df_plot <- df_joined %>% 
  select(sovereignt, status)

df_plot <- na.omit(df_plot)

```

```{r}
pal <- colorFactor(c("#2ca02c", "#377eb8", "#d62728"), domain = df_plot$status)

plot <- leaflet(df_plot) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~pal(status),
              color = "black",
              fillOpacity = 0.7,
              weight = 1,
              popup = ~paste(sovereignt, status)) %>%
  addLegend(pal = pal, values = ~status,
            title = "Status",
            position = "bottomright")
plot
```

**Association**

```{r}
table <- table(df_descriptive$qc19_multinominal,df_descriptive$adp_general)
chisq.test(table)
```

With this results we can conclude that there is a statistically significant relationship between the our dependent variables and the variable that establishes if a country has general legal protections against discrimination for transgender individuals. The cross table below shows that countries with general provisions to protect the transgender community post a higher share of people in favor of expanding transgender rights.

```{r}
CrossTable(df_descriptive$adp_general, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

### Country-level economic variables (GDP per capita and unemployment)

```{r}
data_desc <- df_descriptive  |> 
  select(country_name, qc19_multinominal,`Unemployment. total (% of total labor force) (modeled ILO estimate)`,`GDP per capita (current US$)`)
  
data_desc <- data_desc  |> 
  rename("unemp" = `Unemployment. total (% of total labor force) (modeled ILO estimate)`) |> 
  rename("GDPpc" = `GDP per capita (current US$)`) |> 
  na.omit(data_desc)


# Bar plot for visualizing the unemployment rate for each country
ggplot(data_desc, aes(x = reorder(country_name, unemp), y = unemp)) +
  geom_bar(stat = "identity", fill = "grey", color = "#8073ac") +
  theme_minimal() +
  theme(axis.text.x = element_text(family= "sans",angle = 90, hjust = 1, vjust = 0.5)) +
  labs(title = "Unemployment Rate by Country", x = "Country", y = "Unemployment Rate (%)")

# Bar plot for visualizing the GDP per capita for each country
ggplot(data_desc, aes(x = reorder(country_name, GDPpc), y = log(GDPpc))) + 
  geom_bar(stat = "identity", fill = "grey", color = "#fc4e2a") +
  theme_minimal() +
  theme(axis.text.x = element_text(family= "sans", angle = 90, hjust = 1, vjust = 0.5)) +
  labs(title = "GDP per Capita by Country", x = "Country", y = "Logs of GDP per Capita (US$)")

```

```{r}
#For Unemployment
kruskal_unemp <- kruskal.test(unemp ~ qc19_multinominal, data = data_desc)
print(kruskal_unemp)

# For GDP per Capita
kruskal_gdppc <- kruskal.test(GDPpc ~ qc19_multinominal, data = data_desc)
print(kruskal_gdppc)
```

In both cases, the p-values are less than the significance level of 0.05, we reject the null hypothesis of the Kruskal-Wallis test, which states that the group medians are equal. This results imply that the group medians are not all equal, and there is evidence of a difference among the groups defined by the our dependent variable.

### General conclusion

In this section, we investigated predictors we inferred from the literature and drew conclusion from both the individual and country level.

As such, we present both demographic (e.g. attitudes or share of minorities) and country level characteristics. From the demographic variables we inferred three country-level variables. All three variables pertain to the idea of measuring the general societal sentiment towards attitudes closely tied to the support of transgender rights. These sentiments include attitudes on the binary conception of gender, support for LGB rights and general awareness levels of discrimination against the transgender community. These sentiments foster a societal context shaping what is socially acceptable. We therefore, considered these variables more important than more abstract operationalizations of the discourse space, such as government characteristics. Moreover, we include legal characteristics which portray more accurately government policy which in turn influence support levels. We find all these variables to be statistical significantly associated with the support for transgender rights. 

Aside from these variables - concerning demographic characteristics - we find significant effects of gender, political ideology, religious affiliation, contact with transgender individuals, age, pertaining to a sexual minority, education level, individual economic situation and the place of residence. As such, we confirm large parts of the literature on acceptance of transgender rights.

Lastly, we include general economic variables in order to consider possible repercussions from lack of economic success furthering our individual-level inquiry into the economic situations. Here, we find statistical significance as well.

It is important to note that we identify one key variable to not be influential. Being part of any minority is not associated with support of transgender rights. This is particularly important with regard countries with large self-perceived minorities.

## Statistical modeling

**Dependent Variable (qc19)**

It relates to this question:

*Do you think that transgender persons should be able to change their civil documents to match their inner gender identity?*

We will take the values:

-   1 for "Yes"

-   2 for "No"

```{r}
df_descriptive <- df_descriptive %>%
  mutate(binary_qc19 = ifelse(qc19 == 1, 1, 
                              ifelse(qc19 == 2, 0, NA)))
# there are 3280 NA's

Individual_data <- df_descriptive %>%
  select(serialid,country_name, binary_qc19)
```

INDIVIDUAL LEVEL

**Gender**

```{r}
df_descriptive <- df_descriptive %>%
  mutate(
    male = car::recode(d10, "2=0; 1=1")
  )

Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, male), by = "serialid")

Individual_data$male <- as.numeric(as.character(Individual_data$male))

```

**Age**

The different categories for age will be transformed as factor for better analysis. There are 3 variables that represent four, six and seven categories of age.

```{r}
df_descriptive <- df_descriptive %>%
  mutate(
    Cat_age_four = factor(d11r1, 
                           labels = c("15 - 24", "25 - 39", "40 - 54", ">=55")),
    Cat_age_six = factor(d11r2, 
                           labels = c("15 - 24", "25 - 34", "35 - 44", "45 - 54", "55 - 64", ">=65")),
    Cat_age_seven = factor(d11r3, 
                           labels = c("15 - 24", "25 - 34", "35 - 44", "45 - 54", "55 - 64", "65 - 74", ">=75"))
  )


Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, Cat_age_four,Cat_age_six,Cat_age_seven), by = "serialid")
```

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, d11), by = "serialid")

Individual_data$d11 <- as.numeric(as.character(Individual_data$d11))
```

**Political_ideology**

*In political matters people talk of "the left" and "the right". How would you place your views on this scale?*

```{r}

df_descriptive$d1_ordinal <- relevel(df_descriptive$d1_ordinal, ref = "Left") 
df_descriptive$d1_ordinal[df_descriptive$d1_ordinal %in% c("Non-response", "Don't know", 98)] <- NA

df_descriptive$d1_ordinal <- factor(df_descriptive$d1_ordinal)

df_descriptive <- df_descriptive %>% 
  rename(political_ideology = d1_ordinal) 

Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, political_ideology), by = "serialid")



```

**Religion_cat**

*Do you consider yourself to be…?*

```{r}

df_descriptive <- df_descriptive %>%
  mutate(Religion_cat = case_when(
    sd3_cat == "Catholic" ~ "Catholic",
    sd3_cat == "Orthodox Christian" ~ "Orthodox Christian",
    sd3_cat == "Protestant" ~ "Protestant",
    sd3_cat == "Other Christian" ~ "Other Christian",
    sd3_cat == "Jewish" ~ "Jewish",
    sd3_cat == "Muslim" ~ "Muslim", 
    sd3_cat == "Other" ~ "Other Religion",
    sd3_cat == "Atheist | Agnostic" ~ "Atheist | Agnostic",
    sd3_cat == "Other" ~ "Other Belief",
    TRUE ~ "Other"
  ))

Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, Religion_cat), by = "serialid")

Individual_data$Religion_cat <- factor(Individual_data$Religion_cat)

```

**Contact with transgender people (sd1_7)**

*Do you have friends or acquaintances who are transgender?*

```{r}

df_descriptive <- df_descriptive %>%
  mutate(sd1_7_factor = factor(sd1_7, 
              levels = c(1, 2, 3, 4),
              labels = c("Yes", "No", "Refusal (SPONTANEOUS)", "Don't know")))

Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, sd1_7_factor), by = "serialid")

```

**Age when completing full-time education (d8)**

*How old were you when you stopped full‐time education?*

```{r}

df_descriptive <- df_descriptive %>%
  mutate(age_stopped_education = case_when(
    d8 == 98 ~ NA_real_,  # Refusal treated as missing
    d8 == 99 ~ NA_real_,  # Don't know treated as missing
    d8 == 00 ~ NA_real_,  # Still Studying can be treated as missing or given a special code
    d8 == 01 ~ NA_real_,  # No Education can be treated as missing or given a special code
    TRUE ~ as.numeric(d8) # Convert all other responses to numeric
  ))



Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, age_stopped_education), by = "serialid")

```

**Personal economic situation (d60_ordinal)**

*During the last twelve months, would you say you had difficulties to pay your bills at the end of the month…?*

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, d60_ordinal), by = "serialid")

```

**Sexual minority(sd2_5)**

*Where you live, do you consider yourself to be part of a sexual minority?*

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, sd2_5), by = "serialid")

```

**Place of residence (type) (d25)**

*Would you say you live in a...?*

```{r}
df_descriptive <- df_descriptive %>%
  mutate(area_type = factor(d25, 
                                levels = c(1, 2, 3, 4),
                                labels = c("Rural area or village", 
                                           "Small or middle-sized town", 
                                           "Large town", 
                                           "Don't know")))


Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, area_type), by = "serialid")

```

**Equal rights for the LGB community (qc15_1_ordinal)**

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, qc15_1_ordinal), by = "serialid")

```

**Discrimination against the transgender community (qc1_8_ordinal)**

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, qc1_8_ordinal), by = "serialid")

```

COUNTRY LEVEL

**Variables created earlier country level.**

Examining the influence of country-level proportion of respondents to a particular outcome. Aimed at understanding differences between countries on various outcomes.

These variables include the proportion of individuals who express support for having a third gender option, support for lesbian, gay and bisexual (LGB) rights, and the share of individuals who find discrimination against transgender people to be widespread by country.

```{r}
Country_level <- reduce(list(df_country_1 %>% select(-prop_qc19_yes), 
                             df_country_2 %>% select(-prop_qc19_yes), 
                             df_country_3 %>% select(-prop_qc19_yes)), 
                        full_join, by = "country_name")


Country_level$prop_gndr_bin <- Country_level$prop_gndr_bin / 100
Country_level$prop_lgb_yes <- Country_level$prop_lgb_yes / 100
Country_level$prop_dis_wide <- Country_level$prop_dis_wide / 100

```

**adp_general**

A country-level variable indicating general legal protections against discrimination for transgender individuals, with 0 representing "No" (no protections) and 1 representing "Yes" (protections exist)

```{r}
Country_level <- left_join(Country_level, df_descriptive %>% 
  select(country_name, trans_legal_protection = adp_general) %>% 
  distinct(), by = "country_name")

```

**Country_name**

To control for country effects or to specifically examine how outcomes vary by country we will include the variable created earlier, "country_name".

Unemployment, total (% of total labor force)

```{r}
Country_level <- left_join(Country_level, df_descriptive %>% 
  select(country_name, Unemployment = `Unemployment. total (% of total labor force) (modeled ILO estimate)`) %>% 
  distinct(), by = "country_name")

```

GDP per capita (current US\$)

```{r}
Country_level <- left_join(Country_level, df_descriptive %>% 
  select(country_name, Gdp_per_capita = `GDP per capita (current US$)`) %>% 
  distinct(), by = "country_name")

```

DATA FINAL COUNTRY

```{r}
Data_final_Cntry <- Country_level |>
   select(country_name,prop_gndr_bin, prop_dis_wide,prop_lgb_yes, trans_legal_protection, Gdp_per_capita, Unemployment)
```

DATA FINAL INDIVIDUAL

```{r}

Data_final_Ind <- Individual_data |> 
  select(serialid,country_name,binary_qc19,male, d11, Cat_age_four,Cat_age_six, Cat_age_seven,political_ideology,Religion_cat , sd1_7_factor, age_stopped_education, d60_ordinal,sd2_5,area_type,qc15_1_ordinal)

```

### Imputation

```{r}
summary(is.na(Data_final_Ind))
```

```{r}
library(mice)
library(cowplot)
library(missForest)

```

```{r}

df_age <- data.frame(
  age_stopped_education = Data_final_Ind$age_stopped_education,
  serialid = Data_final_Ind$serialid
)

methods <- c(age_stopped_education = "pmm", serialid = "")  

# Imputation using PMM
imputed_data_pmm <- mice(df_age, m = 5, method = methods, seed = 123)
imputed_pmm <- complete(imputed_data_pmm, action = 1)$age_stopped_education

# Change method to CART for age_stopped_education
methods["age_stopped_education"] <- "cart"
imputed_data_cart <- mice(df_age, m = 5, method = methods, seed = 123)
imputed_cart <- complete(imputed_data_cart, action = 1)$age_stopped_education

# Change method to LASSO for age_stopped_education
methods["age_stopped_education"] <- "lasso.norm"
imputed_data_lasso <- mice(df_age, m = 5, method = methods, seed = 123)
imputed_lasso <- complete(imputed_data_lasso, action = 1)$age_stopped_education

# Change method to RANDOMFOREST for age_stopped_education
methods["age_stopped_education"] <- "rf"
imputed_data_rf <- mice(df_age, m = 5, method = methods, seed = 123)
imputed_rf <- complete(imputed_data_rf, action = 1)$age_stopped_education

# Combine the original and imputed values into a single data frame for comparison
mice_imputed <- data.frame(
  serialid = df_age$serialid,
  original = df_age$age_stopped_education,
  imputed_pmm = imputed_pmm,
  imputed_cart = imputed_cart,
  imputed_lasso = round(imputed_lasso),  
  imputed_rf = imputed_rf  

  )

```

```{r}
# Define variables, titles, and colors for the updated set of distributions
variables <- c("original", "imputed_pmm", "imputed_cart", "imputed_lasso","imputed_rf")
titles <- c("Original distribution", "PMM-imputed distribution", "Cart-imputed distribution", "Lasso-imputed distribution", "Random Forest Imputed Distribution")
colors_fill <- c("#fa9fb5", "#67a9cf", "#807dba", "#fd8d3c","#74c476")
colors_border <- c("#ae017e", "#02818a", "#54278f", "#e31a1c","#006d2c")

# Initialize an empty plot list for the new plots
plots <- list()

# Loop through the updated variables to create plots
# Loop through the updated variables to create plots with an adjusted binwidth
for (i in 1:length(variables)) {
  plots[[i]] <- ggplot(mice_imputed, aes_string(x = variables[i])) +
    geom_histogram(binwidth = 3, fill = colors_fill[i], color = colors_border[i], position = "identity") +
    ggtitle(titles[i]) +
    theme_classic()
}

# Combine the new set of plots into a grid
plot_grid(plotlist = plots, nrow = 3, ncol = 2)
```

The best imputation method seem to be PMM-Imputed distribution

```{r}
Data_final_Ind <- Data_final_Ind %>%
  left_join(mice_imputed %>% select(serialid, imputed_pmm), by = "serialid")
```

```{r}

Data_final_Ind$age_stopped_education <- ifelse(is.na(Data_final_Ind$age_stopped_education), 
                                               Data_final_Ind$imputed_pmm, 
                                               Data_final_Ind$age_stopped_education)

Data_final_Ind <- Data_final_Ind %>% select(-imputed_pmm)

```

### Regression Analysis Individual Level

```{r}
data_reg_ind <- Data_final_Ind |> 
  select(binary_qc19,male, d11 ,political_ideology,Religion_cat , sd1_7_factor, age_stopped_education, d60_ordinal,sd2_5,area_type,qc15_1_ordinal)


data_reg_ind = data_reg_ind %>%
  filter(!is.na(binary_qc19))
```

```{r}

logit_model <- glm(binary_qc19 ~ ., family=binomial(link='logit'), data= data_reg_ind)

summary(logit_model)
```

There are several variables that are not significant. We also tried the regression with the categories of variables for age that we had and they were also not significant. We will now proceed to reduce the variables used.

```{r}
logit_model2 <- glm(binary_qc19 ~ male + d11 + political_ideology + Religion_cat + sd1_7_factor +   d60_ordinal + qc15_1_ordinal, 
                    family = binomial(link = "logit"), data = data_reg_ind)

summary(logit_model2)
```

We are going to transform the age variable to include a quadratic term as we suspect the relationship between age and the dependent variable is not linear.

```{r}
logit_model3 <- glm(binary_qc19 ~ male + d11 + I(d11^2)  + political_ideology +                         Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal, 
                    family = binomial(link = "logit"), data = data_reg_ind)

summary(logit_model3)
```

**Interpretation**

```{r}
exp(coef(logit_model3))
```

**Male:** The odds of supporting Transgender individuals of being able to change their civil document to match their inner gender are about 25.4% lower for males compared to females, since the odds ratio is 0.74.

**d11:** For each one-year increase in age, the odds of the being supportive of Transgender individuals changing their civil document increase by about 1.9%.However, this support is in a decreasing rate as the relationship is non linear suggesting that at some point, increases in age lead to being less in favor of the target variable.

**political_ideology:** Identifying with the political ideology "Right" decreases the odds of the supporting the change in civil documents by transgender individuals to match their inner gender identity by about 22.8%, compared to the baseline category of political ideology.

**Religion_cat:** Identifying as having Catholics faith have a decrease in the odds of about 21.2%, while identifying as having Jewish faith have an odds increase of about 2.3%, in comparison to the baseline category religion.

**sd1_7_factor:** Responding "No" to having friends or acquaintances who are transgender decreases the odds of the supporting Transgender individuals in being able to change their civil documents by about 45.5%, in comparison to the baseline category.

**d60_ordinal:** Responding that during the last twelve month you had difficulties from time to time in paying your bills, slightly increases the odds of being in favor of letting transgender individuals to change their civil document by about 7.5%, while "Almost never/never" increases the odds by about 26.3%.

**qc15_1_ordinal:** Tending to agree that Gay, lesbian and bisexual people should have the same rights as heterosexual people, decreases the odds by about 61.5%, while "Totally disagree" decreases the odds by about 92.9%.

**Conclusion in the Individual Level**

In our analysis at the individual level, we observe that there are distinct factors influencing support for transgender individual's ability to change their civil documents to match their inner gender identity. The variations in support across the different demographics and beliefs in our data highlight the reality and complexity of public opinion on this issue.

Gender and age play significant roles in this matter, confirming literature cited. For the case of gender, females appear to show higher odds of support compared to males. This could be related to the potential influence of the traditional gender roles and perceptions we have on our society. Moreover, the age variables show that there is a slight increase in support for our dependent variable for each additional year of age. This might suggest that life experiences or generational shifts could gradually influence views towards more inclusive attitudes, however, age influence is minimal in comparison to the other variables represented in our regression.

The categorical variable political Ideology significantly impacts attitudes of support for our target variable. The findings suggest that an alignment towards a more conservative view, results in being less supportive to allow changes in the civil document for transgender individuals. It showed a 22.8% decrease of support for our target variables if the individual identified himself as conservative. Additionally, religious affiliation further complicates the picture, as identifying as Catholic decreases the support for the target variable by about 21,2%. In contrast, individuals identifying with the Jewish faith are slightly more supportive, but, we need to take into consideration that in our data set the proportion of individuals identified as Jewish is really small in comparison to the Catholic faith individuals.

Concentrating on the economic aspect, individuals who established that they had not had difficulties in paying the bill, are slightly more supportive of our dependent variables. Indicating that economic factors may intersect with views on rights and equality.

Furthermore, respondents without contact with transgender individuals show a decreasing support for our dependent variable by 45.5%. The findings underscore the crucial importance of representation and visibility for the transgender community, as well as the development of personal relationships that foster understanding and empathy. These will most likely increase the support for allowing transgender individuals to change their civil documents to match their inner gender identity.

To conclude, in this individual-level analysis, support for our dependent variables is influenced by several complex factors that interplay and shape individuals attitudes. Gender, age, political ideology, and religious affiliation are pivotal in transforming an individual's attitudes. More importantly, we want to point out that the significant impact of lacking personal connections with transgender individuals highlights the need for increased interpersonal connections and broader visibility of transgender issues.

### Multi-level analysis

In order to do a multi-leveled analysis we are going to take generalized linear mixed-effects model (GLMM), where country_name will be the variable used as the random effects.

```{r}
Data <- left_join(Data_final_Ind, Data_final_Cntry, by = "country_name")

#taking logs of GDP per capita
Data$Gdp_per_capita_log <- log(Data$Gdp_per_capita)

```

First we check for multicollineality in the fixed effect variable.

```{r}
test_model <- glm(binary_qc19 ~ male + d11 + political_ideology +
                    Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
                    prop_gndr_bin + prop_lgb_yes + trans_legal_protection +
                    Gdp_per_capita_log + Unemployment,
                  data = Data, family = binomial)

vif_values <- vif(test_model)
print(vif_values)
```

All variables are below 10, meaning that there is no evidence of multicollineality.

```{r}
glm_model_1 <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology +
               Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
               prop_gndr_bin + prop_lgb_yes + prop_dis_wide + trans_legal_protection +
               Gdp_per_capita_log + Unemployment + (1 | country_name),
               data = Data, family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glm_model_1)
```

```{r}
glm_model_2 <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology +
               Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
               prop_gndr_bin + prop_dis_wide + Unemployment + (1 | country_name),
               data = Data, family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glm_model_2)
```

The model is clearly overfitted. And it suggests we have scaling issue.

```{r}
Data$d11 <- scale(Data$d11, center = TRUE, scale = TRUE)
Data$Gdp_per_capita_log <- scale(Data$Gdp_per_capita_log, center = TRUE, scale = TRUE)
Data$Unemployment <- scale(Data$Unemployment, center = TRUE, scale = TRUE) 

```

```{r}
glm_model_3 <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology +
               Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
               prop_gndr_bin + prop_lgb_yes + prop_dis_wide + trans_legal_protection +
               Gdp_per_capita_log + Unemployment + (1 | country_name),
               data = Data, family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glm_model_3)
```

Taking out the non-significant variables.

```{r}
glm_model_4 <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology +
               Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
               prop_gndr_bin + prop_dis_wide + Unemployment + (1 | country_name),
               data = Data, family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glm_model_4)
```

```{r}
AIC(glm_model_1)
BIC(glm_model_1)

AIC(glm_model_2)
BIC(glm_model_2)


AIC(glm_model_3)
BIC(glm_model_3)

AIC(glm_model_4)
BIC(glm_model_4)
#glm_model_4 seems to show the besT lowest AIC and BIC
```

```{r}
plot(residuals(glm_model_4, type = "pearson"))
```

There's a large cluster of residuals around zero, which is not unexpected for binary data. We continue with the analysis.

**Q-Q plot for the standardized residuals**

```{r}

qqmath(~ resid(glm_model_4, type = "pearson"), distribution = qnorm,
       main = "Q-Q Plot of Pearson Residuals", xlab = "Theoretical Quantiles", ylab = "Sample Quantiles")
```

We do not see any systematic deviations that could indicate model misspecification. The Q-Q plot shows the residuals are not perfectly normally distributed, which is common and expected pattern for a logistic regression.

### General Conclusion

Based on the results from your multilevele model, we can draw several conclusions regarding cross-country differences in support for transgender individuals obtaining official documents. These are the main variables we could establish that are able to impact the support that transgender individuals have for changing their documents to match their inner gender identity.

**Demographic Variables**

Gender, has a significant negative coefficient indicating that on average, males are less likely to support transgender individuals rights to change their official documents compared to females. The coefficients of age and age squared are significant and negative, suggesting that younger individuals may be more supportive of the target variable but in a decreasing rate.

**Ideology and Religion**

There are categories in Political Ideology that are significant and have a negative impact on our dependent variables. This suggest that having a political ideology more towards the right tends to decrease the support for our target variable.

Moreover, Religion category levels are also significant in many cases. Indicating that religious affiliation is a factor that affect the support, specially we can observe that non-religious categories tend to be more supportive than more conservative religious categorizes.

**Social Representation**

The variable sd1_7_factor that is related to answering the question on where they have a transgender acquaintances. The individuals who responded with an automatic Refusal tend to be the least supportive individuals towards our dependent variable. Highlighting the need for representation and personal connections in creating a supportive environment for transgender individuals' rights. It also indicates that familiarity with transgender individuals, perhaps through personal acquaintances, correlates with increased understanding and advocacy for the necessity to changes to official documents.

Further, we find that not being part of a sexual minority is associated with an extremely high non-supportive attitude regarding the legal provision that transgender individuals should be able to change their civil documents.

**Country Specific Variables**

Indicators on the general support in a country for supporting the possibility of a third gender indication and country-level awareness of discrimination against transgender individuals are strongly associated with higher supportive attitudes towards allowing transgender individuals to change their civil documents. Unemployment resulted significant and positive, suggesting that higher unemployment rates within a country might be associated with greater support for transgender rights, which could indicate a variety of social dynamics.

In conclusion, the main reasons for cross-country differences in support levels for transgender individuals obtaining official documents appear to be related to demographic factors (gender and age), political and religious affiliations, social determinants, awareness regarding LGBTI issues, and economic conditions within a country.

## PREDICTION

We want to create a model that is able to predict the support for transgender individuals changing civil documents. In order to be able to predict our target variable, we need to define the success that we want to predict.

### Definition of support

```{r}
prop_table_yes_no <- prop.table(table(factor(Data_final_Ind$binary_qc19, levels = c(0, 1), labels = c("No", "Yes"))))

prop_table_yes_no
```

We see that the data is balanced in our favor. This is important as it will be easier for us to predict the Yes than the No's. We need to find the factors that are causing this 60% of support for our dependent variable.

The model we are going to use and the data.

```{r}
ModelS = binary_qc19 ~ male + d11 + I(d11^2)  + political_ideology + Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal + Unemployment + prop_gndr_bin + prop_dis_wide


data_pred <- left_join(Data_final_Ind, Data_final_Cntry, by = "country_name")

data_pred <- data_pred |> 
  filter(!is.na(binary_qc19))

data_pred$prop_gndr_bin <- data_pred$prop_gndr_bin / 100
data_pred$prop_dis_wide <- data_pred$prop_dis_wide / 100
```

### Data splitting

```{r}
set.seed(123)

#we move to split the data into testing and training with a 80% split.

in_train <- createDataPartition(y = data_pred$binary_qc19, p = 0.8, list = FALSE)

in_train <- in_train[, 1]

training <- data_pred[in_train, ]
testing <- data_pred[-in_train, ]

#remove rows with NA's
training <- na.omit(training)
testing <- na.omit(testing)
```

We adjust the dependent variable class.

```{r}
# defining the levels of our dependent variable
training$binary_qc19 <- factor(training$binary_qc19, levels = c(0, 1), labels = c("No", "Yes"))

testing$binary_qc19 <- factor(testing$binary_qc19, levels = c(0, 1), labels = c("No", "Yes"))
```

### Predicting using the logistic regression

```{r}
logit.model <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology + Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal + prop_gndr_bin + prop_dis_wide + Unemployment + (1 | country_name),
               data = training,
               family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))


summary(logit.model)
```

```{r}
#use the testing data to predict the target variable
probability <- predict(logit.model, newdata=testing, type='response')

logit_roc <- roc(testing$binary_qc19 ~ probability)

# estimating best threshold balancing specificity and sensitiviy
plot(logit_roc, col="red",print.thres=TRUE)

prediction <- as.factor(ifelse(probability > 0.614, "Yes", "No"))

confusionMatrix(prediction, testing$bin)
```

The above presented confusion matrix drawing on the best possible threshold defined by the ROC curve reports a 76.75% specificity rate and 72.99% sensitivity rate. This means that in 77% and 73% of the times, respectively, a new observation is correctly classified into the 'Yes' or 'No' class. As a whole, this statistical model reports an accuracy of 75.29%.

### Predicting with Machine Learning

```{r}
# we first need to correct the factor levels to be able to run the predictive model

# For political_ideology
levels(training$political_ideology) <- make.names(levels(training$political_ideology), unique = TRUE)
levels(testing$political_ideology) <- make.names(levels(testing$political_ideology), unique = TRUE)
# For Religion_cat
levels(training$Religion_cat) <- make.names(levels(training$Religion_cat), unique = TRUE)
levels(testing$Religion_cat) <- make.names(levels(testing$Religion_cat), unique = TRUE)
# For sd1_7_factor
levels(training$sd1_7_factor) <- make.names(levels(training$sd1_7_factor), unique = TRUE)
levels(testing$sd1_7_factor) <- make.names(levels(testing$sd1_7_factor), unique = TRUE)
# For qc15_1_ordinal
levels(training$qc15_1_ordinal) <- make.names(levels(training$qc15_1_ordinal), unique = TRUE)
levels(testing$qc15_1_ordinal) <- make.names(levels(testing$qc15_1_ordinal), unique = TRUE)
# For d60_ordinal
levels(training$d60_ordinal) <- make.names(levels(training$d60_ordinal), unique = TRUE)
levels(testing$d60_ordinal) <- make.names(levels(testing$d60_ordinal), unique = TRUE)


```

### Setting the control function

```{r}
ctrl <- trainControl(method = "repeatedcv", 
                     number = 10,
                     classProbs = T,
                     summaryFunction=twoClassSummary,
                     verboseIter = T)
```

### Knn

```{r}
set.seed(124)
knnFit <- train(ModelS, 
                  data = training,
                  method = "kknn",   
                  preProc=c('scale','center'),
                  tuneLength = 10, 
                  metric="ROC",
                  trControl = ctrl)
```

```{r}
plot(knnFit)
```

Looking at the plot, we can observe that there is a peak performance at around 10 neighbors and onward. This is where the ROC AUC score is the highest amount the tested values, suggesting that the optimal number of neighbors for our data set, based on the cross validation process is around those values. However, it's worth noting that while higher k values may give a slightly higher AUC, they also make the model more computationally expensive and potentially less sensitive to local variations in the data.

```{r}
knnProb = predict(knnFit, testing, type = "prob")
prediction <- as.factor(ifelse(knnProb[,"Yes"] > 0.5, "Yes", "No"))
confusionMatrix(prediction, testing$binary_qc19)

```

The model has an accuracy of 74.14%, suggesting that a relatively high proportion of predictions are correct. The sensitivity of 60.72% indicates that the model has moderate effectiveness in identifying positive cases, while the specificity of 82.63% shows a stronger performance in predicting negative cases. This may suggest a tendency towards predicting negative outcomes more accurately, which could be reflective of class distribution biases within the data set. Further analysis using other models is necessary to improve the balance and overall predictive performance.

### Decision trees

```{r}
# Hyper-parameters
control = rpart.control(minsplit = 20, maxdepth = 10, cp=0.01)
```

A decision tree:

```{r}
set.seed(125)
dtFit <- rpart(ModelS, data=training, method = "class", control = control)
summary(dtFit)
```

Visualize decision trees:

```{r}
rpart.plot(dtFit, digits=4)
```

**Each node shows:**

-   the predicted class
-   the predicted probability of each class
-   the percentage of observations in the node

**Interpretation of one path:** For individuals who tend to agree or totally agree with qc15_1_ordinal, and who have a prop_gndr_bin value lower than 0.002448, if they also have a prop_dis_wide bigger than 0.002342. This particular path leads to a leaf where 5.16% of the observations within this branch result in a 'Yes' prediction.

**Prediction**

```{r}

dtProb <- predict(dtFit, testing, type = "prob")

prediction <- as.factor(ifelse(dtProb[,"Yes"] > 0.5, "Yes", "No"))

confusionMatrix(prediction, testing$binary_qc19)
```

We can observe an improvement in the model's accuracy, now at 75.29%. There's also a notable increase in sensitivity, which is currently at 62.68%, suggesting better detection of positive cases. Specificity is 83% and is still reflecting strong predictive power for negative cases. These results are more promising and indicate that the model is becoming more robust in terms of overall predictive accuracy and the ability to identify positive instances in comparison to the previous model.

### Using Caret

```{r}
set.seed(134)

caret.fit <- train(ModelS, 
                   data = training, 
                   method = "rpart",
                   control=rpart.control(minsplit = 8, maxdepth = 12),
                   trControl = ctrl,
                   tuneLength=10)
caret.fit
```

**Visualization**

```{r}
rpart.plot(caret.fit$finalModel)
```

Prediction

```{r}
dtProb <- predict(caret.fit, testing, type = "prob")

rocObj <- roc(response = testing$binary_qc19, predictor = dtProb[,"Yes"])
plot(rocObj, col="red", print.thres = TRUE)

prediction <- as.factor(ifelse(dtProb[,"Yes"] > 0.612, "Yes", "No"))

confusionMatrix(prediction, testing$binary_qc19)

```

The model has shown a no improvement in Accuracy, Specificity and Sensitivity. However, is still really unbalanced. These changes suggest that while the model is becoming better at correctly identifying negative cases and overall correct predictions, it is less effective at identifying positive cases.

### Random Forest

```{r}
set.seed(234)
rfFit <- train(ModelS, 
                  data = training,
                  method = "rf",   
                  preProc=c('scale','center'),
                  tuneGrid = data.frame(mtry = 5), # after runing a tuneLength=10 the results gave that the optimal parameter for this model is that.
                  metric="ROC",
                  trControl = ctrl) 

```

Looking at the plot, we can observe that there is a peak performance at 5 neighbors. This is where the ROC AUC score is the highest amount the tested values, suggesting that the optimal number of neighbors for our data set, based on the cross validation process is around this value. This is why the code was change to have a mtry=5 in order to run more rapid and not to take hours.

```{r}
rfProb = predict(rfFit, testing, type="prob")

rocObj <- roc(response = testing$binary_qc19, predictor = rfProb[,"Yes"])
plot(rocObj, col="red", print.thres = TRUE)

prediction <- as.factor(ifelse(rfProb[,"Yes"] > 0.603, "Yes", "No"))

confusionMatrix(prediction, testing$binary_qc19)
```

The model shows a slight decrease in Accuracy. However, the balance for Specificity and Sensitivity has improved.

`NOTE` As the last models where taking more than 8 hours to process, we decided to use Parallel Processing and a custom grid.

```{r}
library(doParallel)
```

```{r}
numCores <- detectCores() - 1
registerDoParallel(cores=numCores)

```

```{r}
ctrl <- trainControl(method = "repeatedcv", 
                     number = 10,
                     repeats = 1,
                     classProbs = TRUE,
                     summaryFunction = twoClassSummary,
                     verboseIter = FALSE,
                     allowParallel = TRUE) # allowing for the parallel processing
```

### Gradient boosting

```{r}
# custom grid to make the computational process run within less than 8 hours, we tune in each parameter and found this one where the optimal onces.
tune_grid_gbm <- expand.grid(
    nrounds = c(100, 600),  
    max_depth = 4,          
    eta = 0.05,     
    gamma = 0,              
    colsample_bytree = 0.8, 
    min_child_weight = 1,   
    subsample = 0.8         
)

set.seed(456)

# Update the train function call to use the new tune grid
gbmFit <- train(ModelS, 
                data = training,
                method = "xgbTree",
                preProc = c('scale', 'center'),
                tuneGrid = tune_grid_gbm,
                metric = "ROC",
                trControl = ctrl)
```

```{r}
plot(gbmFit)
```

Going for more that 600 iterations made the model have a worst ROC.

```{r}
gbmProb = predict(gbmFit, testing, type="prob")
rocObj <- roc(response = testing$binary_qc19, predictor = gbmProb[,"Yes"])
plot(rocObj, col="red", print.thres = TRUE)
```

```{r}
prediction <- as.factor(ifelse(gbmProb[,"Yes"] > 0.603, "Yes", "No"))

confusionMatrix(prediction, testing$binary_qc19)

```

This is the best model so far, with an Accuracy of 75.07%, Sensitivity of 74.64% and a Specificity of 75.35%

Variables Importance

```{r}
gbm_imp <- varImp(rfFit, scale = F)
plot(gbm_imp, scales = list(y = list(cex = .95)))
```

Partial dependence plot for the two most important variables

```{r}
partial(gbmFit, pred.var = "prop_gndr_bin", plot = TRUE, rug = TRUE)
partial(gbmFit, pred.var = "d11", plot = TRUE, rug = TRUE)   
```

For the gndr_bin plot, it shows that as the value of prop_gndr_bin increases, the predicted value (yhat) tends to decrease, meaning that there's a negative association between prop_gndr_bin and the predicted outcome.

For the d11 plot, it shows a more complex, non-linear relationship. This is something we address by adding the quadratic age term.

Both plot further evidence the insight we have gatherer through this analysis.

```{r}
rocObj <- roc(response = testing$binary_qc19, predictor = gbmProb[,"Yes"])
plot(rocObj, print.auc = TRUE)
```

The AUC value of 0.82 suggests that the Gradient Boosting model has a good measure of separability. Meaning that there is an 82% chance that the model is be able to distinguish between positive class (countries supporting the right of transgender individuals to change their civil documents) and negative class (countries not supporting). The curve is also close to the top left corner of the graph, which means that our model has a high sensitivity (it correctly identifies a high percentage of actual positives) and a high specificity (it correctly identifies a high percentage of actual negatives). In conclusion, the ROC curve indicates that the Gradient Boosting model performs well on our data set with a balance between sensitivity and specificity.

### Neural Networks

```{r}
tune_grid_nn <- expand.grid(size = c(3,4), decay = 0.01) # various parameters were used but the best results suggested by the plot code are these values.
set.seed(789)
nn_tune <- train(ModelS, 
                 data = training,
                 method = "nnet",  
                 preProc = c('scale', 'center'),
                 tuneGrid = tune_grid_nn,
                 metric = "ROC",
                 trControl = ctrl,
                 linout = FALSE,
                 trace = FALSE)
```

```{r}
plot(nn_tune)
```

If we choose a value over 4, ROC decreases.

```{r}
nnProb <- predict(nn_tune, testing, type = "prob")

```

```{r}
rocObj <- roc(response = testing$binary_qc19, predictor = nnProb[,"Yes"])
plot(rocObj, col="red", print.thres = TRUE)

```

```{r}
nnPredictedClass <- as.factor(ifelse(nnProb[,"Yes"] > 0.643, "Yes", "No"))
confusionMatrix(nnPredictedClass, testing$binary_qc19)
```

The Accuracy levels decrease to 74%, as well as, the Specificity to 73.27%. For the Sensitivity there is an improvement to 75.14%.

```{r}
rocObj <- roc(response = testing$binary_qc19, predictor = nnProb[,"Yes"])
plot(rocObj, print.auc = TRUE)
```

This plot is further evidence that the best predictive model is the gradient boosting one. As it has a higher AUC, indicating a better overall performance in terms of distinguishing between the two classes of our dependent variable.

### Final Predictive Model

The selected predictive model for our international analysis is Gradient Boosting, which has consistently outperformed all other models in terms of accuracy. This model not only demonstrates the highest accuracy but also achieves the most balanced rates of specificity and sensitivity. Such a robust performance profile makes it the optimal choice for our data set. We found that this model is the most adept and effective at predicting whether countries will support the right of transgender individuals to change their civil documents to reflect their gender identity.

## LITERATURE

Campbell, M., Hinton, J. D. X. & Anderson, J. R. (2019) A systematic review of the relationship between religion and attitudes toward transgender and gender-variant people. International Journal of Transgenderism, 20:1, 21-38, DOI: 10.1080/15532739.2018.1545149

Earle, M. et al. (2020). A multilevel analysis of LGBT (Lesbian, Gay, Bisexual, Transgender) rights support across 77 countries: The role of contact and country laws . British Journal of Social Psychology. doi:10.1111/bjso.12436

Flores, A. R. (2015) Attitudes toward transgender rights: perceived knowledge and secondary interpersonal contact, Politics, Groups, and Identities, 3:3, 398-416, DOI: 10.1080/21565503.2015.1050414

Flores, A. R., Brown, T. N. T., & Park, A. S. (2016). Public Support for Transgender Rights: A Twenty-three Country Survey. The Williams Institute at UCLA School of Law. http://www.jstor.org/stable/resrep34965

Harrison, B.F., Michelson, M.R. (2019) Gender, Masculinity Threat, and Support for Transgender Rights: An Experimental Study. Sex Roles 80, 63–75. https://doi.org/10.1007/s11199-018-0916-6 Norton, A.T., Herek, G.M. Heterosexuals’ Attitudes Toward Transgender People: Findings from a National Probability Sample of U.S. Adults. Sex Roles 68, 738–753 (2013).

Williamson, Myles, 2023, "Replication Data for: A Global Analysis of Transgender Rights: Introducing the Trans Rights Indicator Project (TRIP)", https://doi.org/10.7910/DVN/FXXLTS, Harvard Dataverse, V1, UNF:6:E4O2rb6DFd44VSZjm9SQNQ== \[fileUNF\]

World Bank. (n.d.). DataBank: World Development Indicators \[Economy & Growth\]. Retrieved March 13, 2024, from https://databank.worldbank.org/source/world-development-indicators)
