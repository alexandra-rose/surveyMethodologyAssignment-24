---
title: "Final Assignment"
author: Frederick Peña, Alexandra Salo and Sofia Villamil
format: html
editor: visual
editor_options: 
  chunk_output_type: inline
---

# Final Assignment

### Libraries

```{r}
rm(list = ls())

setwd("C:/Users/sofia/Documents/Documentos/Master Computational Social Sciences/Survey Research Methodology II/Final Assignment/surveyMethodologyAssignment-24")
```

```{r}
library(haven)
library(readr)
library(haven)
library(writexl)
library(sjlabelled)
library(tidyverse)
library(corrplot)
library(dplyr)
library(gmodels)
library(scales)
library(rnaturalearth)
library(sf)
library(ggplot2)
library(leaflet)
library(tidyverse)
library(MASS)
library(caret)
library(plotly)
library(car)
library(caret)
library(rpart)
library(rpart.plot)
library(lme4)
```

### Data

```{r}
data <- read_dta("Data/ZA7575.dta")

```

## DATA CLEANING

Cleaning specific variables to determine which are the more important once for our analysis.

**ID**

```{r}
data_cleaning_1 <- data %>%
  select(
         -c(studyno1, studyno2, doi, version, edition,survey))

data_cleaning_2 <- data_cleaning_1 %>% 
  select(serialid, everything())
```

**Country ID**

```{r}
# creating a variable for country name to be more organized
data_cleaning_2$country_name <- NA
data_cleaning_2$country_name[data_cleaning_2$q1_1 == 1] <- 'Belgium'
data_cleaning_2$country_name[data_cleaning_2$q1_2 == 1] <- 'Denmark'
data_cleaning_2$country_name[data_cleaning_2$q1_3 == 1] <- 'Germany'
data_cleaning_2$country_name[data_cleaning_2$q1_4 == 1] <- 'Greece'
data_cleaning_2$country_name[data_cleaning_2$q1_5 == 1] <- 'Spain'
data_cleaning_2$country_name[data_cleaning_2$q1_6 == 1] <- 'France'
data_cleaning_2$country_name[data_cleaning_2$q1_7 == 1] <- 'Ireland'
data_cleaning_2$country_name[data_cleaning_2$q1_8 == 1] <- 'Italy'
data_cleaning_2$country_name[data_cleaning_2$q1_9 == 1] <- 'Luxembourg'
data_cleaning_2$country_name[data_cleaning_2$q1_10 == 1] <- 'Netherlands'
data_cleaning_2$country_name[data_cleaning_2$q1_11 == 1] <- 'Portugal'
data_cleaning_2$country_name[data_cleaning_2$q1_12 == 1] <- 'United Kingdom'
data_cleaning_2$country_name[data_cleaning_2$q1_13 == 1] <- 'Austria'
data_cleaning_2$country_name[data_cleaning_2$q1_14 == 1] <- 'Sweden'
data_cleaning_2$country_name[data_cleaning_2$q1_15 == 1] <- 'Finland'
data_cleaning_2$country_name[data_cleaning_2$q1_16 == 1] <- 'Cyprus'
data_cleaning_2$country_name[data_cleaning_2$q1_17 == 1] <- 'Czech Republic'
data_cleaning_2$country_name[data_cleaning_2$q1_18 == 1] <- 'Estonia'
data_cleaning_2$country_name[data_cleaning_2$q1_19 == 1] <- 'Hungary'
data_cleaning_2$country_name[data_cleaning_2$q1_20 == 1] <- 'Latvia'
data_cleaning_2$country_name[data_cleaning_2$q1_21 == 1] <- 'Lithuania'
data_cleaning_2$country_name[data_cleaning_2$q1_22 == 1] <- 'Malta'
data_cleaning_2$country_name[data_cleaning_2$q1_23 == 1] <- 'Poland'
data_cleaning_2$country_name[data_cleaning_2$q1_24 == 1] <- 'Slovakia'
data_cleaning_2$country_name[data_cleaning_2$q1_25 == 1] <- 'Slovenia'
data_cleaning_2$country_name[data_cleaning_2$q1_26 == 1] <- 'Bulgaria'
data_cleaning_2$country_name[data_cleaning_2$q1_27 == 1] <- 'Romania'
data_cleaning_2$country_name[data_cleaning_2$q1_28 == 1] <- 'Croatia'
data_cleaning_2$country_name[data_cleaning_2$q1_29 == 1] <- 'Other countries'
data_cleaning_2$country_name[data_cleaning_2$q1_30 == 1] <- 'DK'
```

```{r}
# factor
data_cleaning_2$country_name <- factor(data_cleaning_2$country_name)

```

### Extra Country Level Variables

**Legal variable**

We believe that the data was missing some variables related to the legality aspect in a country level so we found this data.

Citation: Williamson, Myles, 2023, "Replication Data for: A Global Analysis of Transgender Rights: Introducing the Trans Rights Indicator Project (TRIP)", <https://doi.org/10.7910/DVN/FXXLTS,> Harvard Dataverse, V1, UNF:6:E4O2rb6DFd44VSZjm9SQNQ== \[fileUNF\]

```{r}
Data_Extra_by_Country <- read_delim("data_extra_by_Country.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

all_na_columns <- sapply(Data_Extra_by_Country, function(x) all(is.na(x)))

# There are columns with all NA due to the filtering in stata done before for the year 2019.

columns_to_remove <- names(Data_Extra_by_Country)[all_na_columns]

# remove the columns
Data_Extra_by_Country <- Data_Extra_by_Country[, !all_na_columns]
Data_Extra_by_Country <- Data_Extra_by_Country[, !names(Data_Extra_by_Country) %in% "e_polity2"]

# dataframe of all the variables for 2019 related to legal or political views of most of the countries in the world
```

Looking into the extra data set

```{r}
Data_Extra_by_Country$country_name <- factor(Data_Extra_by_Country$country_name)
```

The variables chosen are the following:

```{r}
Data_Extra_by_Country <- Data_Extra_by_Country %>% 
  select(country_name,adp_general)
```

```{r}
merged_df_1 <- merge(data_cleaning_2, Data_Extra_by_Country, by = "country_name", all.x = TRUE)
```

**Economic Variables**

The economic variables we choose were Unempoyment and GDP per capita.

The data was attained from the World Bank.

Citation: World Bank. (n.d.). DataBank: World Development Indicators \[Economy & Growth\]. Retrieved March 13, 2024, from <https://databank.worldbank.org/source/world-development-indicators>

```{r}
Eco_Extra_Data <- read_delim("Eco Extra Data.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) 
```

```{r}
merged_df <- merge(merged_df_1, Eco_Extra_Data, by = "country_name", all.x = TRUE)
```

## DESCRIPTIVE ANALYSIS

### First look at association

-   the descriptive analysis will oscillate between individual-level and country-level analysis

### Question

-   what to do with refusal ? = NA
-   what to do with don't know? = NA

### Gender

Assumption from literature –\> men less supportive than women

```{r}

df_descriptive <- merged_df

df_descriptive$qc19_multinominal <- factor(df_descriptive$qc19, levels = c(1, 2, 3),labels = c("Yes", "No", "Don't know"))

qc19labels <- c("Yes", "No", "Don't know")
names(qc19labels) <- c(1, 2, 3)

df_descriptive |>
  mutate(d10 = as.factor(d10),
         qc19_n = as.numeric(qc19),
         qc19 = as.factor(qc19)) |> 
  group_by(d10) |> 
  mutate(gsumqc19 = sum(qc19_n)) |> 
  ungroup() |> 
  group_by(qc19, d10) |> 
  mutate(gshare19 = (sum(qc19_n)/gsumqc19)*100) |> 
  ungroup() |> 
  ggplot(aes(x = qc19_multinominal, y = gshare19, fill = d10))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", gshare19))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  labs(title = "Do you think that transgender persons should be able to change\ntheir civil documents to match their inner gender identity?",
y = NULL,
x = NULL,
caption = "Source: Eurobarometer 91.4") +
  scale_fill_manual(labels = c("Men", "Women"), values = c("blue", "red")) +
  theme_minimal() +
  theme(legend.position = "bottom") +  # Adjust legend position
  guides(fill = guide_legend(title = NULL))  # Hide legend title


```

### Binary conception of gender

predictor of support of US sample

operationalization using question 20 on if there should be a third gender option

Table

```{r}
df_descriptive$qc20_multinominal <- factor(df_descriptive$qc20, levels = c(1, 2, 3),labels = c("Yes", "No", "Don't know"))

CrossTable(df_descriptive$qc19_multinominal, df_descriptive$qc20_multinominal, 
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Since the p-value is much smaller than the conventional significance level of 0.05, we reject the null hypothesis. This suggests that there is a significant association between the variables **`qc19`** and **`qc20`**.

Very high convergence of people against a third gender option and rejecting

88.29% of those against a third gender option also negate the option for transgender persons to change their gender in civil documents.

```{r}
plot_binary_1 <-
  df_descriptive |> 
  group_by(country_name) |> 
  summarise(share_no = mean(qc20 == 2, na.rm = TRUE)*100) |> 
  arrange(desc(share_no)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share_no)) +
  geom_col(fill = "red") +
  labs(x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share_no))),vjust = -0.5, size = 2)  +
  annotate("text", x = 9.5, y = 70, 
           label = "Share of 'No' responses to qc19:\nDo you think that transgender persons should be able to change\ntheir civil documents to match their inner gender identity?",
           hjust = 0, vjust = 0.5, size = 3, color = "black") +
  geom_rect(aes(xmin = 9.3, xmax = 24.3, 
                ymin = 62, ymax = 77),
                fill = "transparent", color = "black", linewidth = 1)

plot_binary_2 <- 
  df_descriptive |> 
  group_by(country_name) |> 
  summarise(share_no = mean(qc19 == 2, na.rm = TRUE)*100) |> 
  arrange(desc(share_no)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share_no)) +
  geom_col(fill = "red") +
  labs(x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 90, hjust= 0),
        plot.margin = margin(-10, 0, 0, 0)) +
  scale_x_discrete(position = "top") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share_no))), vjust = -0.5, size = 2)  +
  annotate("text", x = 10, y = 65, 
           label = "Share of 'No' responses to qc20:\nDo you believe that official documents, like passports and birth\ncertificates, should have a third option, such as X or O (other)\nbeside male (M) and female (F)for those persons who do not\nidentify as female and male?",
           hjust = 0, vjust = 0.5, size = 3, color = "black") +
  geom_rect(aes(xmin = 9.8, xmax = 24.6, 
                ymin = 53, ymax = 76),
                fill = "transparent", color = "black", linewidth = 1)
```

```{r}
#| echo: false
#| layout-ncol: 1

plot_binary_1
plot_binary_2
```

-   visually this high convergence can also be seen on the country level

-   to verify this statistically, the Spearman rank test is used as the country-level proportions are not normally distributed

-   the statistical association between agreeing there should be a third gender option and supporting the ability for transgender people to change their civil document on the country level is estimated

-   the Spearman rank test reports a very strong positive relationship between the two variables supporting the previous assertion that the acceptance of a third gender differentiates countries concerning their average approval of the civil document alteration for transgender people

```{r}
df_country_1 <- 
  df_descriptive |>
  group_by(country_name) |> 
  summarize(
    prop_gndr_bin = (sum(qc20_multinominal == "Yes") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_1$prop_gndr_bin, df_country_1$prop_qc19_yes, method = "spearman")
```

### Political ideology

```{r}
df_descriptive$d1_ordinal <- factor(df_descriptive$d1, levels = c(1, 2, 3, 4 , 5, 6, 7, 8, 9, 10, 97, 98),labels = c("Left", "2", "3", "4", "5", "6", "7", "8", "9", "Right", "Non-response", "Don't know"))

CrossTable(df_descriptive$d1_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Note:

-   25% of people chose 5, the exact middle ground

Surprising results:

-   The inherent idea is upheld that a greater share of more left-leaning people are in favor

-   However, difference to very right-leaning people is not that great (60-30 left vs. 43-45 right)

Problem:

-   self-reporting self-right scale might not be so accurate

-   a lot of information is hidden in the non-response and don't know groups of political ideology as they have greater don't know rates for qc19

Take-away

-   Still significant association (but maybe not as strong as suspected)

```{r}

df_descriptive |> 
  mutate(d1_bin = case_when(
    d1 < 4 ~ "Left",
    d1 < 8 ~ "Middle",
    d1 < 11 ~ "Right",
    TRUE ~ "DK/Refusal"
  )) |> 
  mutate(d1_bin = fct_relevel(d1_bin, "DK/Refusal", after = Inf)) |> 
  group_by(d1_bin, qc19_multinominal) |> 
  summarise(count = n()) |> 
  group_by(d1_bin) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = d1_bin, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by political ideology",
       x = "Political Ideology",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

#### Add government ideology as better proxy

### Religiosity

```{r}
df_descriptive <-
  df_descriptive |> 
  mutate(sd3_cat = case_when(sd3 == 1 ~ "Catholic",
                             sd3 == 2 ~ "Orthodox Christian",
                             sd3 == 3 ~ "Protestant",
                             sd3 == 4 ~ "Other Christian",
                             sd3 == 5 ~ "Jewish",
                             sd3 < 9 ~ "Muslim", 
                             sd3 < 12 ~ "Other",
                             sd3 < 14 ~ "Atheist | Agnostic",
                             sd3 == 14 ~ "Other",
                             sd3 > 14 ~ "Don't know | Refusal")) 

CrossTable(df_descriptive$sd3_cat, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Problem:

-   Very low counts for Jewish, Muslim, Other and Other Christian as can be seen in the plot below

```{r}
df_descriptive |> 
  mutate(sd3_cat = fct_relevel(sd3_cat, "Don't know | Refusal", after = Inf)) |> 
  ggplot(aes(x = sd3_cat)) +
  geom_bar(fill = "black", color = "black", alpha = 0.5) +
  labs(title = "Frequency by religious affiliation",
       x = "",
       y = "Absolutec count",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Findings:

-   on the individual level not believing in God more say yes as well as Protestant

-   Catholics in favor but less strongly

-   Orthodox Christian strong outlier with being against it

Summary:

-   roughly one may say that countries with a higher share of Orthodox Christians may be rather against it

```{r}
df_descriptive |> 
  group_by(country_name) |> 
  summarise(share = mean(sd3_cat == "Orthodox Christian", na.rm = TRUE)*100) |> 
  arrange(desc(share)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share)) +
  geom_col(fill = "red") +
  labs(title = "Share of Orthodox Christians", 
       x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share))),vjust = -0.5, size = 2)
```

### Contact

```{r}
df_descriptive <-
  df_descriptive |> 
  mutate(
    sd1_7_NA = car::recode(sd1_7, "1=1; 2=0; 3=NA; 4=2"),
    sd1_7_multinomial = factor(sd1_7_NA, levels = c(0, 1, 2), labels = c("No", "Yes", "Don't know"))
  )

CrossTable(df_descriptive$sd1_7_multinomial, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

-   association is statistically significant

-   the majority of people did not have contact with a transgender person

-   there is a clear tendency on the individual level that among those that have not had contact with a transgender person the approval is relatively lower as for those who have had the margin is very clear (76% vs 18%)

-   contact is associated rather with approval. Not having had contact not associated with being against, just lower approval

-   this is visualised below

```{r}
df_descriptive|> 
  drop_na(sd1_7_multinomial) |> 
  group_by(sd1_7_multinomial, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd1_7_multinomial) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd1_7_multinomial, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by previous conatct with transgender person",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Age

-   using anova to seek out differences between those who responded 'yes', 'no', don't know' by age

-   p-value let's us reject the null hypothesis. There is a statistically significant difference between at least two groups

```{r}
anova <- aov(d11 ~ qc19_multinominal, data = df_descriptive)
summary(anova)
```

-   visualizing group difference using boxplots

-   showing that the strongest difference is between those saying 'yes' and those stating 'don't know'

-   implies there is valuable information from particularly older people missing

```{r}
ggplot(df_descriptive, aes(x = qc19_multinominal, y = d11, fill = "red")) +
  geom_boxplot(color = "red") +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by age",
       y = "Age",
       x = "Support",
       caption = "Source: Eurobarometer 91.4") +
  theme(legend.position = "none")
```

-   regarding the difference between 'yes' and 'no' - those reporting the former are generally a bit younger

-   employ a correlation to look at strength and direction of the association while differentiating only between Yes and No

```{r}
df_cor_age <- 
  df_descriptive |> 
  select(qc19, d11) |> 
  filter(qc19 < 3) |> # filtering out everything besides 1 and 2
  mutate(qc19 = ifelse(qc19 == 2, 0, qc19)) # Assigning 2 the number 0 for logical interpretation

cor(df_cor_age$d11, df_cor_age$qc19)
```

-   as already implied above only a slight relation ship

-   negative direction shows that a one year increase in age decreases approval

### Awareness

-   if type of discrimination is widespread in own country

```{r}
df_descriptive$qc1_8_ordinal <- factor(df_descriptive$qc1_8, levels = c(1, 2, 3, 4 , 5, 6),labels = c("Very wide spread", "Fairly wide spread", "Fairly rare", "Very rare", "Nonexistent
", "DK"))

CrossTable(df_descriptive$qc1_8_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

-   p-value lets us very confidently state that there is a statistically significant relationship between the variables

-   among those reporting transgender people face very or fairly wide spread discrimination, the relative support for the possibility to change civil documents is greater than for those stating it is fairly rare, while among those reporting it is very rare the share between supporters and opponents is balanced

-   this clear association between more awareness and greater support is visible below

```{r}
df_descriptive|> 
  drop_na(qc1_8_ordinal) |> 
  group_by(qc1_8_ordinal, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(qc1_8_ordinal) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = qc1_8_ordinal, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

-   between countries

-   countries which have a higher share of approval are to be found rather towards the

```{r}
df_descriptive |> 
  mutate(qc1_8_ordinal = case_when(
    qc1_8_ordinal == "Very wide spread" ~ "Very or fairly wide spread",
    qc1_8_ordinal == "Fairly wide spread" ~ "Very or fairly wide spread",
    TRUE ~ qc1_8_ordinal
  )) |>
  group_by(country_name) |> 
  summarise(share = mean(qc1_8_ordinal == "Very or fairly wide spread", na.rm = TRUE)*100) |> 
  arrange(desc(share)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share)) +
  geom_col(fill = "red") +
  labs(title = "Share of respondents perceiving discrimination against transgender people\nto be very of fairly wide spread", 
       x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share))),vjust = -0.5, size = 2)
```

-   to further investigate the country-level differences the association of the proportion of individuals aware of discrimination per country and the proportion of individuals in favor of the ability of transgender people to change their civil documents

-   because the variables are non-normally distributed, we use the Spearman rank test

```{r}
df_country_2 <-
  df_descriptive |> 
  mutate(qc1_8_ordinal = case_when(
    qc1_8_ordinal == "Very wide spread" ~ "Very or fairly wide spread",
    qc1_8_ordinal == "Fairly wide spread" ~ "Very or fairly wide spread",
    TRUE ~ qc1_8_ordinal
  )) |> 
  group_by(country_name) |> 
  summarize(
    prop_dis_wide = (sum(qc1_8_ordinal == "Very or fairly wide spread") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_2$prop_dis_wide, df_country_2$prop_qc19_yes, method = "spearman")
```

-   the test shows a strong relationship between awareness of discrimination faced by transgender people on the country-level insuating that in countries with greater awareness there is greater support

### Solidarity among minority groups

```{r}
df_descriptive <- 
  df_descriptive |>  
  mutate(
    sd2t = factor(sd2t, levels = c(0, 1), labels = c("Not mentioned", "Yes"))
  )
```

As the subsequent plot demonstrates, there is no general solidarity among minority group expressed by a greater support for transgender people than among individuals without any minority-background.

```{r}
df_descriptive|> 
  drop_na(sd2t) |> 
  group_by(sd2t, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd2t) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd2t, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

However, this support is much greater among people who themselves are a sexual minority. As such, people with similar experiences as transgender people are more likely to support transgender rights.

```{r}
df_descriptive <- 
  df_descriptive |>  
  mutate(
    sd2_5 = factor(sd2_5, levels = c(0, 1), labels = c("Not mentioned", "Yes"))
  )


df_descriptive|> 
  drop_na(sd2_5) |> 
  group_by(sd2_5, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd2_5) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd2_5, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Education

-   age when leaving formal education

-   expected that higher and lower ages are outliers

-   one is able to gauge differences between the 'yes' and 'no' respondents with the former reporting a slightly higher age as their mode (highest frequency)

```{r}
df_descriptive <- 
  df_descriptive |> 
  mutate(d8 = case_when(d8 < 98 ~ d8,
                        TRUE ~ NA)) # turning don't know and refusal into NA to keep continuous character of the variable - imputed later


ggplot(df_descriptive, aes(x = qc19_multinominal, y = d8, fill = "red")) +
  geom_boxplot(color = "red") +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by age",
       y = "Age when leaving formal education",
       x = "Support",
       caption = "Source: Eurobarometer 91.4") +
  theme(legend.position = "none")

```

The ANOVA analysis supports the claim, at least, that the groups are statistically significantly different from one another.

```{r}
anova <- aov(d8 ~ qc19_multinominal, data = df_descriptive)
summary(anova)
```

```{r}
df_cor_age <- 
  df_descriptive |> 
  select(qc19, d8) |> 
  filter(qc19_multinominal < 3) |> # filtering out everything besides 1 and 2
  mutate(qc19 = ifelse(qc19 == 2, 0, NA)) # Assigning 2 the number 0 for logical interpretation

cor(df_cor_age$d8, df_cor_age$qc19)
```

The correlation shows there is a very weak association in favor of the literature's case that being more educated is associated with an increased support of transgender rights.

### The economic situation

-   During the last twelve months, would you say you had difficulties to pay your bills at the end of the month…?

```{r}

df_descriptive <- 
  df_descriptive |> 
  mutate(
    d60 = car::recode(d60, "4=NA"),
    d60_ordinal = factor(d60, levels = c(1, 2, 3), labels = c("Most of the time", "From time to time", "Almost never/ never"))
  )

CrossTable(df_descriptive$d60_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

-   following the literature, among those who never or almost never had difficulties to pay their bills at the end of the month, the support for the possibility of transgender people to alter their gender in their civic documents is markedly higher.

-   the low p-value indicates that the association is statistically significant

-   confers with literature

-   this difference is visualized by the graph below

```{r}
df_descriptive|> 
  drop_na(d60_ordinal) |> 
  group_by(d60_ordinal, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(d60_ordinal) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = d60_ordinal, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by times having difficulties to pay the bills in last 12 months",
       x = "Having difficulties to pay the bills in last 12 months",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Support for LGBT rights

```{r}
df_descriptive <- 
  df_descriptive |> 
  mutate(
    qc15_1_ordinal = factor(qc15_1, levels = c(1, 2, 3, 4, 5), labels = c("Totally agree", "Tend to agree", "Tend to disagree", "Totally disagree", "Don't know"))
  )

CrossTable(df_descriptive$qc15_1_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

-   the p-value indicates statistical significance concerning the association between the two variables

-   as may be expected, among those disagreeing that people part of the LGB community should have equal rights the support is very low and the rejection of the possibility

-   rejection is almost as pronounced as the support regarding transgender people's ability to change their gender identification of those who totally agree people of the LGB community should have the same rights

-   important: two way association

-   on the country level

```{r}
df_country_3 <- 
  df_descriptive |>
  mutate(qc15_1_ordinal = case_when(
    qc15_1_ordinal == "Totally agree" ~ "Totally or tend to agree",
    qc15_1_ordinal == "Tend to agree" ~ "Totally or tend to agree",
    TRUE ~ qc15_1_ordinal
  )) |> 
  group_by(country_name) |> 
  summarize(
    prop_lgb_yes = (sum(qc15_1_ordinal == "Totally or tend to agree") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_3$prop_lgb_yes, df_country_3$prop_qc19_yes, method = "spearman")
```

-   very strong association on the country level indicating that most likely countries where there is greater support for the legal equality for LGB people also post higher support rates for the adoption of legislation allowing transgender people to change their gender in civic documents

-   this only captures the support direction. As outlined above, a similar strength may be expected for the revers association.

### Legal protections for the transgender community by country level

To observe if there is are general legal protections across various countries within our data set, an interactive map was developed.

```{r}
df <- df_descriptive %>% 
  select(country_name, adp_general)
df$country_name <- as.character(df$country_name)

df_unique <- df %>%
  group_by(country_name) %>%
  summarise(adp_general = max(adp_general)) %>%
  ungroup()

europe_map <- ne_countries(scale = "medium", continent = "europe", returnclass = "sf")

df_joined <- left_join(europe_map, df_unique, by = c("sovereignt" = "country_name"))

```

```{r}
df_joined$status <- case_when(
  df_joined$adp_general == 1 ~ "General",
  df_joined$adp_general == 0 ~ "None",
  TRUE ~ "No Information"
)

df_plot <- df_joined %>% 
  select(sovereignt, status)

df_plot <- na.omit(df_plot)

```

```{r}
pal <- colorFactor(c("#2ca02c", "#377eb8", "#d62728"), domain = df_plot$status)

plot1 <- leaflet(df_plot) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~pal(status),
              color = "black",
              fillOpacity = 0.7,
              weight = 1,
              popup = ~paste(sovereignt, status)) %>%
  addLegend(pal = pal, values = ~status,
            title = "Status",
            position = "bottomright")
plot1
```

**Association**

```{r}
table <- table(df_descriptive$qc19_multinominal,df_descriptive$adp_general)
chisq.test(table)
```

With this results we can conclude that there is a statistically significant relationship between the our dependent variables and the variable that establish if a country has general legal protections against discrimination for transgender individuals.

### Descriptive analysis for country level economic variables (GDP per capita and unemployment)

```{r}
data_desc <- df_descriptive  |> 
  select(country_name, qc19_multinominal,`Unemployment. total (% of total labor force) (modeled ILO estimate)`,`GDP per capita (current US$)`)
  
data_desc <- data_desc  |> 
  rename("unemp" = `Unemployment. total (% of total labor force) (modeled ILO estimate)`) |> 
  rename("GDPpc" = `GDP per capita (current US$)`)


# Bar plot for visualizing the unemployment rate for each country
ggplot(data_desc, aes(x = reorder(country_name, unemp), y = unemp)) +
  geom_bar(stat = "identity", fill = "grey", color = "#8073ac") +
  theme_minimal() +
  theme(axis.text.x = element_text(family= "sans",angle = 90, hjust = 1, vjust = 0.5)) +
  labs(title = "Unemployment Rate by Country", x = "Country", y = "Unemployment Rate (%)")

# Bar plot for visualizing the GDP per capita for each country
ggplot(data_desc, aes(x = reorder(country_name, GDPpc), y = log(GDPpc))) + 
  geom_bar(stat = "identity", fill = "grey", color = "#fc4e2a") +
  theme_minimal() +
  theme(axis.text.x = element_text(family= "sans", angle = 90, hjust = 1, vjust = 0.5)) +
  labs(title = "GDP per Capita by Country", x = "Country", y = "Logs of GDP per Capita (US$)")

```

```{r}
#For Unemployment
kruskal_unemp <- kruskal.test(unemp ~ qc19_multinominal, data = data_desc)
print(kruskal_unemp)

# For GDP per Capita
kruskal_gdppc <- kruskal.test(GDPpc ~ qc19_multinominal, data = data_desc)
print(kruskal_gdppc)
```

In both cases, the p-values are less than the significance level of 0.05, we reject the null hypothesis of the Kruskal-Wallis test, which states that the group medians are equal. This results imply that the group medians are not all equal, and there is evidence of a difference among the groups defined by the our dependent variable.

### MODELING

**Dependent Variable (qc19)**

It relates to this question:

*Do you think that transgender persons should be able to change their civil documents to match their inner gender identity?*

We will take the values:

-   1 for "Yes"

-   2 for "No"

```{r}
df_descriptive <- df_descriptive %>%
  mutate(binary_qc19 = ifelse(qc19 == 1, 1, 
                              ifelse(qc19 == 2, 0, NA)))
# there are 3280 NA's

Individual_data <- df_descriptive %>%
  select(serialid,country_name, binary_qc19)
```

INDIVIDUAL LEVEL

**Gender**

```{r}
df_descriptive <- df_descriptive %>%
  mutate(
    male = car::recode(d10, "2=0; 1=1")
  )

Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, male), by = "serialid")

Individual_data$male <- as.numeric(as.character(Individual_data$male))

```

**Age**

The different categories for age will be transformed as factor for better analysis. There are 3 variables that represent four, six and seven categories of age.

```{r}
df_descriptive <- df_descriptive %>%
  mutate(
    Cat_age_four = factor(d11r1, 
                           labels = c("15 - 24", "25 - 39", "40 - 54", ">=55")),
    Cat_age_six = factor(d11r2, 
                           labels = c("15 - 24", "25 - 34", "35 - 44", "45 - 54", "55 - 64", ">=65")),
    Cat_age_seven = factor(d11r3, 
                           labels = c("15 - 24", "25 - 34", "35 - 44", "45 - 54", "55 - 64", "65 - 74", ">=75"))
  )


Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, Cat_age_four,Cat_age_six,Cat_age_seven), by = "serialid")
```

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, d11), by = "serialid")

Individual_data$d11 <- as.numeric(as.character(Individual_data$d11))
```

**Political_ideology**

*In political matters people talk of "the left" and "the right". How would you place your views on this scale?*

```{r}

df_descriptive$d1_ordinal <- relevel(df_descriptive$d1_ordinal, ref = "Left") 
df_descriptive$d1_ordinal[df_descriptive$d1_ordinal %in% c("Non-response", "Don't know", 98)] <- NA

df_descriptive$d1_ordinal <- factor(df_descriptive$d1_ordinal)

df_descriptive <- df_descriptive %>% 
  rename(political_ideology = d1_ordinal) 

Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, political_ideology), by = "serialid")



```

**Religion_cat**

*Do you consider yourself to be…?*

```{r}

df_descriptive <- df_descriptive %>%
  mutate(Religion_cat = case_when(
    sd3_cat == "Catholic" ~ "Catholic",
    sd3_cat == "Orthodox Christian" ~ "Orthodox Christian",
    sd3_cat == "Protestant" ~ "Protestant",
    sd3_cat == "Other Christian" ~ "Other Christian",
    sd3_cat == "Jewish" ~ "Jewish",
    sd3_cat == "Muslim" ~ "Muslim", 
    sd3_cat == "Other" ~ "Other Religion",
    sd3_cat == "Atheist | Agnostic" ~ "Atheist | Agnostic",
    sd3_cat == "Other" ~ "Other Belief",
    TRUE ~ "Other"
  ))

Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, Religion_cat), by = "serialid")

Individual_data$Religion_cat <- factor(Individual_data$Religion_cat)

```

**sd1_7**

*Do you have friends or acquaintances who are transgender?*

```{r}

df_descriptive <- df_descriptive %>%
  mutate(sd1_7_factor = factor(sd1_7, 
              levels = c(1, 2, 3, 4),
              labels = c("Yes", "No", "Refusal (SPONTANEOUS)", "Don't know")))

Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, sd1_7_factor), by = "serialid")

```

**d8**

*How old were you when you stopped full‐time education?*

```{r}

df_descriptive <- df_descriptive %>%
  mutate(age_stopped_education = case_when(
    d8 == 98 ~ NA_real_,  # Refusal treated as missing
    d8 == 99 ~ NA_real_,  # Don't know treated as missing
    d8 == 00 ~ NA_real_,  # Still Studying can be treated as missing or given a special code
    d8 == 01 ~ NA_real_,  # No Education can be treated as missing or given a special code
    TRUE ~ as.numeric(d8) # Convert all other responses to numeric
  ))



Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, age_stopped_education), by = "serialid")

```

**d60_ordinal**

*During the last twelve months, would you say you had difficulties to pay your bills at the end of the month…?*

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, d60_ordinal), by = "serialid")

```

**Sexual minority(sd2_5)**

*Where you live, do you consider yourself to be part of a sexual minority?*

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, sd2_5), by = "serialid")

```

**d25**

*Would you say you live in a...?*

```{r}
df_descriptive <- df_descriptive %>%
  mutate(area_type = factor(d25, 
                                levels = c(1, 2, 3, 4),
                                labels = c("Rural area or village", 
                                           "Small or middle-sized town", 
                                           "Large town", 
                                           "Don't know")))


Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, area_type), by = "serialid")

```

**qc15_1_ordinal**

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, qc15_1_ordinal), by = "serialid")

```

**qc1_8_ordinal**

```{r}
Individual_data <- left_join(Individual_data, df_descriptive %>% select(serialid, qc1_8_ordinal), by = "serialid")

```

COUNTRY LEVEL

**Variables created earlier country level.**

Examining the influence of country-level proportion of respondents to a particular outcome. Aimed at understanding differences between countries on various outcomes.

```{r}
Country_level <- reduce(list(df_country_1 %>% select(-prop_qc19_yes), 
                             df_country_2 %>% select(-prop_qc19_yes), 
                             df_country_3 %>% select(-prop_qc19_yes)), 
                        full_join, by = "country_name")


Country_level$prop_gndr_bin <- Country_level$prop_gndr_bin / 100
Country_level$prop_lgb_yes <- Country_level$prop_lgb_yes / 100
Country_level$prop_dis_wide <- Country_level$prop_dis_wide / 100

```

**adp_general**

A country-level variable indicating general legal protections against discrimination for transgender individuals, with 0 representing "No" (no protections) and 1 representing "Yes" (protections exist)

```{r}
Country_level <- left_join(Country_level, df_descriptive %>% 
  select(country_name, trans_legal_protection = adp_general) %>% 
  distinct(), by = "country_name")

```

**Country_name**

To control for country effects or to specifically examine how outcomes vary by country we will include the variable created earlier, "country_name".

Unemployment, total (% of total labor force)

```{r}
Country_level <- left_join(Country_level, df_descriptive %>% 
  select(country_name, Unemployment = `Unemployment. total (% of total labor force) (modeled ILO estimate)`) %>% 
  distinct(), by = "country_name")

```

GDP per capita (current US\$)

```{r}
Country_level <- left_join(Country_level, df_descriptive %>% 
  select(country_name, Gdp_per_capita = `GDP per capita (current US$)`) %>% 
  distinct(), by = "country_name")

```

DATA FINAL COUNTRY

```{r}
Data_final_Cntry <- Country_level |>
   select(country_name,prop_gndr_bin, prop_dis_wide,prop_lgb_yes, trans_legal_protection, Gdp_per_capita, Unemployment)
```

DATA FINAL INDIVIDUAL

```{r}

Data_final_Ind <- Individual_data |> 
  select(serialid,country_name,binary_qc19,male, d11, Cat_age_four,Cat_age_six, Cat_age_seven,political_ideology,Religion_cat , sd1_7_factor, age_stopped_education, d60_ordinal,sd2_5,area_type,qc15_1_ordinal)

```

### Regression Analysis Individual Level

```{r}
data_reg_ind <- Data_final_Ind |> 
  select(binary_qc19,male, d11 ,political_ideology,Religion_cat , sd1_7_factor, age_stopped_education, d60_ordinal,sd2_5,area_type,qc15_1_ordinal)


data_reg_ind = data_reg_ind %>%
  filter(!is.na(binary_qc19))
```

```{r}

logit_model <- glm(binary_qc19 ~ ., family=binomial(link='logit'), data= data_reg_ind)

summary(logit_model)
```

There are several variables that are not significant. We also tried the regression with the categories of variables for age that we had and they were also not significant. We will now proceed to reduce the variables used.

```{r}
logit_model2 <- glm(binary_qc19 ~ male + d11 + political_ideology + Religion_cat + sd1_7_factor +   d60_ordinal + qc15_1_ordinal, 
                    family = binomial(link = "logit"), data = data_reg_ind)

summary(logit_model2)

```

We are going to transform the age variable to include a quadratic term as we suspect the relationship between age and the dependent variable is not linear.

```{r}
logit_model3 <- glm(binary_qc19 ~ male + d11 + I(d11^2)  + political_ideology +                         Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal, 
                    family = binomial(link = "logit"), data = data_reg_ind)

summary(logit_model3)
```

**Interpretation**

```{r}
exp(coef(logit_model3))
```

**Male:** The odds of supporting Transgender individuals of being able to change their civil document to match their inner gender are about 25.4% lower for males compared to females, since the odds ratio is 0.74.

**d11:** For each one-year increase in age, the odds of the being supportive of Transgender individuals changing their civil document increase by about 1.9%.However, this support is in a decreasing rate as the relationship is non linear suggesting that at some point, increases in age lead to being less in favor of the target variable.

**political_ideology:** Identifying with the political ideology "Right" decreases the odds of the supporting the change in civil documents by transgender individuals to match their inner gender identity by about 22.8%, compared to the baseline category of political ideology.

**Religion_cat:** Identifying as having Catholics faith have a decrease in the odds of about 21.2%, while identifying as having Jewish faith have an odds increase of about 2.3%, in comparison to the baseline category religion.

**sd1_7_factor:** Responding "No" to having friends or acquaintances who are transgender decreases the odds of the supporting Transgender individuals in being able to change their civil documents by about 45.5%, in comparison to the baseline category.

**d60_ordinal:** Responding that during the last twelve month you had difficulties from time to time in paying your bills, slightly increases the odds of being in favor of letting transgender individuals to change their civil document by about 7.5%, while "Almost never/never" increases the odds by about 26.3%.

**qc15_1_ordinal:** Tending to agree that Gay, lesbian and bisexual people should have the same rights as heterosexual people, decreases the odds by about 61.5%, while "Totally disagree" decreases the odds by about 92.9%.

**Conclusion in the Individual Level**

In our analysis at the individual level, we observe that there are distinct factors influencing support for transgender individual's ability to change their civil documents to match their inner gender identity. The variations in support across the different demographics and beliefs in our data highlight the reality and complexity of public opinion on this issue.

Gender and Age play significant roles in this matter. For the case of Gender, females appear to show higher odds of support compared to males. This could be related to the potential influence of the traditional gender roles and perceptions we have on our society. Moreover, the Age variables show that there is a slight increase in support for our dependent variable for each additional year of age. This might suggests that life experiences or generational shifts could gradually influence views towards more inclusive attitudes, however, age influence is minimal in comparison to the other variables represented in our regression.

The categorical variable Political Ideology significantly impacts attitudes of support for our target variable. The finding displayed suggest that an alignment towards more conservative view, results in being less supportive to allow changes in the civil document for transgender individuals. It showed a 22.8% decrease of support for our target variables if the individual identified himself as conservative. Additionally, Religious affiliation further complicates the picture, as identifying as Catholic decrease the support for transgender by about 21,2%. In contrast, individuals identifying with the Jewish faith are slightly more supportive, thus, we need to take into consideration that in our data set the proportion of individuals identified as Jewish is really small in comparison to the Catholic faith individuals.

Concentrating now on the economic aspect, individuals who established that they have not had difficulties in paying the bill, are slightly more supportive of our dependent variables. Indicating that economic factors may intersect with views on rights and equality.

For more of a social perception, individuals who responded that they lack connections with transgender individuals show a decreasing support for our dependent variable by 45.5%. The findings underscore the crucial importance of representation and visibility for the transgender community, as well as the development of personal relationships that foster understanding and empathy. These will most likely will increase the support for allowing transgender individuals to change their civil documents to match their inner gender identity.

In conclusion, support for our dependent variables is influenced by several complex factors that interplay and shape individuals attitudes. Gender, age, political ideology, and religious affiliation are pivotal in transforming individual' s attitudes.More importantly, we want to point out that the significant impact of lacking personal connections with transgender individuals highlight the need for increased interpersonal connections and broader visibility of transgender issues. Paving the way for greater acceptance and legislative support in the progress of changing their legal documents, and thus, shifting societal norms and attitudes.

### Multi-level analysis

In order to do a multi-leveled analysis we are going to take generalized linear mixed-effects model (GLMM). Where country_name will be the variable used as the random effects.

```{r}
Data <- left_join(Data_final_Ind, Data_final_Cntry, by = "country_name")

#taking logs of GDP per capita
Data$Gdp_per_capita_log <- log(Data$Gdp_per_capita)

```

First we check for multicolineality in the fixed effect variable

```{r}
test_model <- glm(binary_qc19 ~ male + d11 + political_ideology +
                    Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
                    prop_gndr_bin + prop_lgb_yes + trans_legal_protection +
                    Gdp_per_capita_log + Unemployment,
                  data = Data, family = binomial)

vif_values <- vif(test_model)
print(vif_values)
```

All variables are below 10, meaning that there is no evidence of multicolineality.

```{r}
glm_model_1 <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology +
               Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
               prop_gndr_bin + prop_lgb_yes + prop_dis_wide + trans_legal_protection +
               Gdp_per_capita_log + Unemployment + (1 | country_name),
               data = Data, family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glm_model_1)
```

```{r}
glm_model_2 <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology +
               Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
               prop_gndr_bin + prop_dis_wide + Unemployment + (1 | country_name),
               data = Data, family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glm_model_2)
```

The model is clearly over fitted. And it suggests we have scaling issue.

```{r}
Data$d11 <- scale(Data$d11, center = TRUE, scale = TRUE)
Data$Gdp_per_capita_log <- scale(Data$Gdp_per_capita_log, center = TRUE, scale = TRUE)
Data$Unemployment <- scale(Data$Unemployment, center = TRUE, scale = TRUE) 

```

```{r}
glm_model_3 <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology +
               Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
               prop_gndr_bin + prop_lgb_yes + prop_dis_wide + trans_legal_protection +
               Gdp_per_capita_log + Unemployment + (1 | country_name),
               data = Data, family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glm_model_3)
```

Taking out the non-significant variables.

```{r}
glm_model_4 <- glmer(binary_qc19 ~ male + d11 + I(d11^2) + political_ideology +
               Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal +
               prop_gndr_bin + prop_dis_wide + Unemployment + (1 | country_name),
               data = Data, family = binomial, 
               control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(glm_model_4)
```

```{r}
AIC(glm_model_1)
BIC(glm_model_1)

AIC(glm_model_2)
BIC(glm_model_2)


AIC(glm_model_3)
BIC(glm_model_3)

AIC(glm_model_4)
BIC(glm_model_4)
#glm_model_4 seems to show the besT lowest AIC and BIC
```

```{r}
plot(residuals(glm_model_4, type = "pearson"))
```

There's a large cluster of residuals around zero, which is not unexpected for binary data. We continue with the analysis.

**Q-Q plot for the standardized residuals**

```{r}
library(lattice)
qqmath(~ resid(glm_model_4, type = "pearson"), distribution = qnorm,
       main = "Q-Q Plot of Pearson Residuals", xlab = "Theoretical Quantiles", ylab = "Sample Quantiles")
```

We do not see any systematic deviations that could indicate model misspecification. The Q-Q plot shows the residuals are not perfectly normally distributed, which is common and expected pattern for a logistic regression.

### General Conclusion

Based on the results from your multileveled model, we can draw several conclusions regarding cross-country differences in support for transgender individuals obtaining official documents. These are the main variables we could establish that are able to impact the support that transgender individuals have for changing their documents to match their inner gender identity.

**Demographic Variables**

Gender, has a significant negative coefficient indicating that on average, males are less likely to support transgender individuals rights to change their official documents compared to females. The coefficients of age and age squared are significant and negative, suggesting that younger individuals may be more supportive of the target variable but in a decreasing rate.

**Ideology and Religion**

There are categories in Political Ideology that are significant and have a negative impact on our dependent variables. This suggest that having a political_ideology more towards the right tends to decrease the support for our target variable.

Moreover, Religion category levels are also significant in many cases. Indicating that religious affiliation is a factor that affect the support, specially we can observe that non-religious categories tend to be more supportive than more conservative religious categorizes.

**Social Representation**

The variable sd1_7_factor that is related to answering the question on where they have a transgender acquaintances. The individuals who responded with an automatic Refusal tend to be the least supportive individuals towards our dependent variable. Highlighting the need for representation and personal connections in creating a supportive environment for transgender individuals' rights. It also indicates that familiarity with transgender individuals, perhaps through personal acquaintances, correlates with increased understanding and advocacy for the necessity to changes to official documents.

The variable qc_15_1 shows that being in total disagreement that Gay, lesbian and bisexual people should have the same rights as heterosexual people, related to a extremely high non-supportive actitud towards agreeing that transgender individuals should be able to change their civil documents.

**Country Specific Variables**

General support in a country for accepting that there should be a third gender option and agreeing that transgender discrimination is widespread in their own country indicate a really high supportive general attitude towards allowing transgender individuals to change their civil documents. Unemployment resulted significant and positive, suggesting that higher unemployment rates within a country might be associated with greater support for transgender rights, which could indicate a variety of social dynamics.

In conclusion, the main reasons for cross-country differences in support levels for transgender individuals obtaining official documents appear to be related to demographic factors (gender and age), political and religious affiliations, social determinants, awareness regarding LGBTI issues, and economic conditions within a country.

## PREDICTION

We want to create a model that is able to predict the support for transgender individuals changing civil documents. In order to be able to predict our target variable, we need to define the success that we want to predict.

### Definition of support

```{r}
prop_table_yes_no <- prop.table(table(factor(Data_final_Ind$binary_qc19, levels = c(0, 1), labels = c("No", "Yes"))))

prop_table_yes_no
```

We see that the data is balanced in our favor below, there are more Yes than there are No's, this is important as it will be easier for us to predict the Yes than the No's. We need to find the factors that are causing this 60% of support for our dependent variable.

The model we are going to use and the data.

```{r}
ModelS = binary_qc19 ~ male + d11 + I(d11^2)  + political_ideology + Religion_cat + sd1_7_factor + d60_ordinal + qc15_1_ordinal + Unemployment + prop_gndr_bin + prop_dis_wide


data_pred <- left_join(Data_final_Ind, Data_final_Cntry, by = "country_name")


data_pred = data_pred %>%
  filter(!is.na(binary_qc19))

data_pred$prop_gndr_bin <- data_pred$prop_gndr_bin / 100
data_pred$prop_dis_wide <- data_pred$prop_dis_wide / 100
```

### Data splitting

```{r}
set.seed(123)

#we move to split the data into testing and training with a 80% split.

in_train <- createDataPartition(y = data_pred$binary_qc19, p = 0.8, list = FALSE)

in_train <- in_train[, 1]

training <- data_pred[in_train, ]
testing <- data_pred[-in_train, ]



#remove rows with NA's
training <- na.omit(training)
testing <- na.omit(testing)

```

### Predicting using the logistic regression

```{r}
logit.model = glm(ModelS , data = training, family = binomial)

summary(logit.model)
```

```{r}
ctrl <- trainControl(method = "cv") # 10-fold cross-validation number = 10) 
significant_vars <- c()


#use the testing data to predict the target variable
probability <- predict(logit.model, newdata=testing, type='response')
head(probability)

prediction <- as.factor(ifelse(probability > 0.5, TRUE, FALSE))
head(prediction)
```

With the output generated we can establish that the model predicts that in observation 6, there's a 78.25% probability that the outcome is TRUE for this observation. Which is a high probability and thus, indicating that there is a strong confidence in the outcome being TRUE. While probabilities significantly below 50% indicate a FALSE outcomes like observation 8. However, further analysis is needed using Machine Learning Methodology to find the best suttee predictive model for our data.

### Predicting with Machine Learning

```{r}
ctrl <- trainControl(method = "repeatedcv", 
                     number = 10,
                     classProbs = T,
                     summaryFunction=twoClassSummary,
                     verboseIter = T)

# defining the levels of our dependent variable
training$binary_qc19 <- factor(training$binary_qc19, levels = c(0, 1), labels = c("No", "Yes"))

testing$binary_qc19 <- factor(testing$binary_qc19, levels = c(0, 1), labels = c("No", "Yes"))

```

```{r}
# we first need to correct the factor levels to be able to run the predictive model

# For political_ideology
levels(training$political_ideology) <- make.names(levels(training$political_ideology), unique = TRUE)
levels(testing$political_ideology) <- make.names(levels(testing$political_ideology), unique = TRUE)
# For Religion_cat
levels(training$Religion_cat) <- make.names(levels(training$Religion_cat), unique = TRUE)
levels(testing$Religion_cat) <- make.names(levels(testing$Religion_cat), unique = TRUE)
# For sd1_7_factor
levels(training$sd1_7_factor) <- make.names(levels(training$sd1_7_factor), unique = TRUE)
levels(testing$sd1_7_factor) <- make.names(levels(testing$sd1_7_factor), unique = TRUE)
# For qc15_1_ordinal
levels(training$qc15_1_ordinal) <- make.names(levels(training$qc15_1_ordinal), unique = TRUE)
levels(testing$qc15_1_ordinal) <- make.names(levels(testing$qc15_1_ordinal), unique = TRUE)
# For d60_ordinal
levels(training$d60_ordinal) <- make.names(levels(training$d60_ordinal), unique = TRUE)
levels(testing$d60_ordinal) <- make.names(levels(testing$d60_ordinal), unique = TRUE)


```

### Knn

```{r}
knnFit <- train(ModelS, 
                  data = training,
                  method = "kknn",   
                  preProc=c('scale','center'),
                  tuneLength = 10, 
                  metric="ROC",
                  trControl = ctrl)
```

```{r}
plot(knnFit)
```

Looking at the plot, we can observe that there is a peak performance at around 10 neighbors and onward. This is where the ROC AUC score is the highest amount the tested values, suggesting that the optimal number of neighbors for our data set, based on the cross validation process is around those values. However, it's worth noting that while higher k values may give a slightly higher AUC, they also make the model more computationally expensive and potentially less sensitive to local variations in the data.

```{r}
knnProb = predict(knnFit, testing, type = "prob")
prediction <- as.factor(ifelse(knnProb[,"Yes"] > 0.5, "Yes", "No"))
confusionMatrix(prediction, testing$binary_qc19)

```

The model has an accuracy of 73.81%, suggesting that a relatively high proportion of predictions are correct. The sensitivity of 61% indicates that the model has moderate effectiveness in identifying positive cases, while the specificity of 82.01% shows a stronger performance in predicting negative cases. This may suggest a tendency towards predicting negative outcomes more accurately, which could be reflective of class distribution biases within the data set. Further analysis using other models is necessary to improve the balance and overall predictive performance.

### Decision trees

```{r}
# Hyper-parameters
control = rpart.control(minsplit = 20, maxdepth = 10, cp=0.01)
```

A decision tree:

```{r}
dtFit <- rpart(ModelS, data=training, method = "class", control = control)
summary(dtFit)
```

Visualize decision trees:

```{r}
rpart.plot(dtFit, digits=4)
```

**Each node shows:**

-   the predicted class
-   the predicted probability of each class
-   the percentage of observations in the node

**Interpretation of one path:** For individuals who tend to agree or totally agree with qc15_1_ordinal, and who have a prop_gndr_bin value higher than 0.002947, if they also identify their Religion_cat as Muslim or Orthodox Christian, the decision tree classifies them as 'Yes'. This particular path leads to a leaf where 56.40% of the observations within this branch result in a 'Yes' prediction.

**Prediction**

```{r}
dtPred <- predict(dtFit, testing, type = "class")

dtProb <- predict(dtFit, testing, type = "prob")

prediction <- as.factor(ifelse(dtProb[,"Yes"] > 0.5, "Yes", "No"))

confusionMatrix(prediction, testing$binary_qc19)
```

We can observe an improvement in the model's accuracy, now at 75%. There's also a notable increase in sensitivity, which is currently at 63.29%, suggesting better detection of positive cases. Specificity remains nearly unchanged and is still reflecting strong predictive power for negative cases. These results are more promising and indicate that the model is becoming more robust in terms of overall predictive accuracy and the ability to identify positive instances in comparison to the previous model.

### Using Caret

```{r}
caret.fit <- train(ModelS, 
                   data = training, 
                   method = "rpart",
                   control=rpart.control(minsplit = 8, maxdepth = 12),
                   trControl = ctrl,
                   tuneLength=10)
caret.fit
```

**Visualization**

```{r}
rpart.plot(caret.fit$finalModel)
```

Prediction

```{r}
dtProb <- predict(caret.fit, testing, type = "prob")

prediction <- as.factor(ifelse(dtProb[,"Yes"] > 0.5, "Yes", "No"))

confusionMatrix(prediction, testing$binary_qc19)

```

The model has shown a slight improvement in both Accuracy and Specificity. However, there has been a slight decrease in Sensitivity. These changes suggest that while the model is becoming better at correctly identifying negative cases and overall correct predictions, it is becoming marginally less effective at identifying positive cases.

### Random Forest

```{r}
rfFit <- train(ModelS, 
                  data = training,
                  method = "rf",   
                  preProc=c('scale','center'),
                  tuneLength = 10, 
                  metric="ROC",
                  trControl = ctrl)

```

```{r}
plot(rfFit)
```

Looking at the plot, we can observe that there is a peak performance at 5 neighbors. This is where the ROC AUC score is the highest amount the tested values, suggesting that the optimal number of neighbors for our data set, based on the cross validation process is around this value.

```{r}
rfProb = predict(rfFit, testing, type="prob")
prediction <- as.factor(ifelse(rfProb[,"Yes"] > 0.5, "Yes", "No"))

confusionMatrix(prediction, testing$binary_qc19)
```

The model shows a slight improvement in both Accuracy, Specificity and Sensitivity. From the models we have seen so far, this is the best one.

### Gradient boosting

```{r}
ctrl <- trainControl(method = "repeatedcv", 
                     number = 5,
                     classProbs = T,
                     summaryFunction=twoClassSummary,
                     verboseIter = F)

gbmFit <- train(ModelS, 
                  data = training,
                  method = "xgbTree",   
                  preProc=c('scale','center'),
                  tuneLength = 20,
                  metric="ROC",
                  trControl = ctrl)

plot(gbmFit)
```

```{r}

gbmProb = predict(gbmFit, testing, type="prob")
prediction <- as.factor(ifelse(gbmProb[,"Yes"] > 0.5, "Yes", "No"))

confusionMatrix(prediction, testing$binary_qc19)

```

Interpretation

```{r}
# Assessing variable importance
gbm_imp <- varImp(rfFit, scale = F)
plot(gbm_imp, scales = list(y = list(cex = .95)))
```

```{r}
# Generate partial dependence plots for important variables
partial(gbmFit, pred.var = "variable impo", plot = TRUE, rug = TRUE)
partial(gbmFit, pred.var = "variable impo", plot = TRUE, rug = TRUE)
```

### Neural Networks

```{r}

nn_tune <- train(ModelS, 
                 data = training,
                 method = "nnet",  
                 preProc = c('scale', 'center'),
                 trControl = ctrl,
                 tuneGrid = expand.grid(size = c(4, 2),  
                                        decay = c(0.1, 0.01)),  
                 metric = "ROC",
                 linout = FALSE)

plot(nn_tune)

```

```{r}
nnProb <- predict(nn_tune, testing, type = "prob")
nnPredictedClass <- as.factor(ifelse(nnProb[,"Yes"] > 0.5, "Yes", "No"))
confusionMatrix(nnPredictedClass, testing$binary_qc19)
```

```{r}
library(pROC)
rocObj <- roc(response = testing$binary_qc19, predictor = nnProb[,"Yes"])
plot(rocObj, print.auc = TRUE)
```

### Final Predictive model

The predictive model for other countries chosen is the
