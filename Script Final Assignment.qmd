---
title: "Final Assignment"
author: Sofia Villamil
format: html
editor: visual
editor_options: 
  chunk_output_type: inline
---

# Final Assignment

CHALLENGE

The assignment has two primary objectives:

1\. Explaining Cross-Country Differences in Support Levels: This aspect involves analyzing the data to understand why different countries exhibit varying levels of support for transgender individuals obtaining official documents (cq19 in the questionnare). Individual-level indicators need to be complemented with country-level factors such as cultural norms, legal systems, history, economic-related variables, and societal views on LGBTI rights.

2.  Developing a Predictive Model for Other Countries This task involves building a model to predict support for transgender individuals changing civil documents to align with their gender identity. By using factors identified in the first part of the assignment, machine learning techniques will be applied to forecast support levels based on observed trends. To ensure the model’s accuracy and reliability, it must undergo thorough calibration and validation. Key steps in this process include selecting relevant features (variables), choosing an appropriate modeling method (such as regression analysis, decision trees, neural networks, etc.), training the model with survey data, and subsequently testing its predictions against known outcomes. A thorough understanding of the data, expertise in data analysis and statistical modeling, along with a deep awareness of the complexities surrounding LGBTI rights, are essential for successfully completing this assignment.

Target variable: qc19 (support for changing gender on documents)

ASSIGMENT SUBMISSION GUIDELINES Teams are responsible for assembling a comprehensive package for submission. This package must include:

• Code: Complete and well-documented source code developed for the project. • Narrative Explanation: A detailed narrative of the work, not exceeding four pages (excluding references).

This narrative should articulate the reasoning behind strategic choices, describe the challenges encountered and how they were overcome, and present/discuss the main results. The completed package must be uploaded to the designated task on Aula Global.

### Libraries

```{r}
rm(list = ls())
```

```{r}

library(haven)
library(writexl)
library(sjlabelled)
library(tidyverse)
library(corrplot)
library(dplyr)
library(gmodels)
library(scales)
```

### Data

```{r}
data <- read_dta("./Data/ZA7575.dta")
```

## Cleaning the data

/////The first step is looking into the data set and removing variables that we found were not important for our analisis.

```{r}
data_cleaning_1 <- data %>%
  select(
         -c(studyno1, studyno2, doi, version, edition,survey,w1:w86,wex,
      p13be, p13ee, p13es, p13fi, p13lu, p13lv, p13mt, 
      cntry_de, eu6, eu9, eu10, eu12_1, eu12_2, eu_nms3, 
      eu15, eu_nms10, eu25, eu_ac2, eu_cc3, euroz13, 
      euronz13, eu_nms12, eu27, eu27b, eu_nms13, eu28, 
      euroz15, euronz15, euroz16, euronz16, euroz17, 
      eurnz17a, eurnz17b, euroz18, eurnz18a, eurnz18b, 
      eurnz18c, euroz19, euronz19, p2, p3r, p4, p5, d71_1:qa4b_8, qa5b_1:qa5b_13,        qa7:qb9_12
    )
  )
```

The variables p2,p4,p3r,p4 and p5 where variable related to certain characteristics of the interview itself, we deemed them not relevant due to their context.

The p13's variables where the language the interview was conducted with.

The rest of the variables are related to the NATION GROUP, so we decided to take them out as we have other variables that seem to explain the same and be more relevant.///////

I WOULD TAKE ALL OF THIS OUT

**Cleaning specific variables to determine which are the more important once for our analysis.**

**Id**

```{r}
data_cleaning_2 <- data_cleaning_1 %>% 
  select(serialid, everything())
```

#### Country

```{r}
# creating a variable for country name to be more organized
data_cleaning_2$country_name <- NA
data_cleaning_2$country_name[data_cleaning_2$q1_1 == 1] <- 'Bélgica'
data_cleaning_2$country_name[data_cleaning_2$q1_2 == 1] <- 'Dinamarca'
data_cleaning_2$country_name[data_cleaning_2$q1_3 == 1] <- 'Alemania'
data_cleaning_2$country_name[data_cleaning_2$q1_4 == 1] <- 'Grecia'
data_cleaning_2$country_name[data_cleaning_2$q1_5 == 1] <- 'España'
data_cleaning_2$country_name[data_cleaning_2$q1_6 == 1] <- 'Francia'
data_cleaning_2$country_name[data_cleaning_2$q1_7 == 1] <- 'Irlanda'
data_cleaning_2$country_name[data_cleaning_2$q1_8 == 1] <- 'Italia'
data_cleaning_2$country_name[data_cleaning_2$q1_9 == 1] <- 'Luxemburgo'
data_cleaning_2$country_name[data_cleaning_2$q1_10 == 1] <- 'Países Bajos'
data_cleaning_2$country_name[data_cleaning_2$q1_11 == 1] <- 'Portugal'
data_cleaning_2$country_name[data_cleaning_2$q1_12 == 1] <- 'Reino Unido'
data_cleaning_2$country_name[data_cleaning_2$q1_13 == 1] <- 'Austria'
data_cleaning_2$country_name[data_cleaning_2$q1_14 == 1] <- 'Suecia'
data_cleaning_2$country_name[data_cleaning_2$q1_15 == 1] <- 'Finlandia'
data_cleaning_2$country_name[data_cleaning_2$q1_16 == 1] <- 'República de Chipre'
data_cleaning_2$country_name[data_cleaning_2$q1_17 == 1] <- 'República Checa'
data_cleaning_2$country_name[data_cleaning_2$q1_18 == 1] <- 'Estonia'
data_cleaning_2$country_name[data_cleaning_2$q1_19 == 1] <- 'Hungría'
data_cleaning_2$country_name[data_cleaning_2$q1_20 == 1] <- 'Letonia'
data_cleaning_2$country_name[data_cleaning_2$q1_21 == 1] <- 'Lituania'
data_cleaning_2$country_name[data_cleaning_2$q1_22 == 1] <- 'Malta'
data_cleaning_2$country_name[data_cleaning_2$q1_23 == 1] <- 'Polonia'
data_cleaning_2$country_name[data_cleaning_2$q1_24 == 1] <- 'Eslovaquia'
data_cleaning_2$country_name[data_cleaning_2$q1_25 == 1] <- 'Eslovenia'
data_cleaning_2$country_name[data_cleaning_2$q1_26 == 1] <- 'Bulgaria'
data_cleaning_2$country_name[data_cleaning_2$q1_27 == 1] <- 'Rumanía'
data_cleaning_2$country_name[data_cleaning_2$q1_28 == 1] <- 'Croacia'
data_cleaning_2$country_name[data_cleaning_2$q1_29 == 1] <- 'Otros países'
data_cleaning_2$country_name[data_cleaning_2$q1_30 == 1] <- 'DK'  # no idea what this is

# factor
data_cleaning_2$country_name <- factor(data_cleaning_2$country_name)
```

```{r}
data_cleaning_2 <- data_cleaning_2 %>% 
  select(serialid,country_name, everything())

data_cleaning_3 <- select(data_cleaning_2, -c(q1_1:q1_30))
```

#### Age

The different categories for age will be transformed as factor for better analysis. There are 3 variables that represent four, six and seven categories of age.

```{r}
data_cleaning_3 <- data_cleaning_3 %>%
  mutate(
    Cat_age_four = factor(d11r1, 
                           labels = c("15 - 24", "25 - 39", "40 - 54", ">=55")),
    Cat_age_six = factor(d11r2, 
                           labels = c("15 - 24", "25 - 34", "35 - 44", "45 - 54", "55 - 64", ">=65")),
    Cat_age_seven = factor(d11r3, 
                           labels = c("15 - 24", "25 - 34", "35 - 44", "45 - 54", "55 - 64", "65 - 74", ">=75"))
  )

```

```{r}
data_cleaning_4 <- select(data_cleaning_3, -c(d11r1,d11r2,d11r3))
```

#### Gender

```{r}
data_cleaning_4 <- data_cleaning_4 %>%
  mutate(
    gender = case_when(
      d10 == 1 ~ "male",
      d10 == 2 ~ "female"
    ),
    gender = factor(gender, levels = c("male", "female"))
  )

```

#### Dependent Variable (qc19)

The dependent variable takes the values

-   1 for "Yes"

-   2 for "No"

-   3 for "Don't Know"

```{r}
#making multinominal variable

data_cleaning_4$qc19_multinominal <- factor(data_cleaning_4$qc19, levels = c(1, 2, 3),labels = c("Yes", "No", "Don't know"))


# if the variable is binary

```

```{r}
data_cleaning_5 <- data_cleaning_4 %>% 
  select(serialid,qc19_multinominal,country_name,gender,d11, everything())
```

### Extra Country Level Variables

We believe that the data was missing some variables related to the legality aspect in a country level so we found this data.

Citation: Williamson, Myles, 2023, "Replication Data for: A Global Analysis of Transgender Rights: Introducing the Trans Rights Indicator Project (TRIP)", <https://doi.org/10.7910/DVN/FXXLTS,> Harvard Dataverse, V1, UNF:6:E4O2rb6DFd44VSZjm9SQNQ== \[fileUNF\]

" The Trans Rights Indicator Project (TRIP) provides insight into the legal situations transgender people faced in 173 countries from 2000 to 2021. The data set currently includes 14 indicators that capture the presence or absence of laws related to criminalization, legal gender recognition, and anti-discrimination protections "

```{r}
library(haven)
library(readr)

data_extra_by_Country <- read_delim("data_extra_by_Country.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)


all_na_columns <- sapply(data_extra_by_Country, function(x) all(is.na(x)))

# There are columns all NA due to filtering in stata done before.

columns_to_remove <- names(data_extra_by_Country)[all_na_columns]

# remove the columns
Data_Extra_by_Country <- data_extra_by_Country[, !all_na_columns]
Data_Extra_by_Country <- Data_Extra_by_Country[, !names(Data_Extra_by_Country) %in% "e_polity2"]

# dataframe of all the variables for 2019 related to legal or political views of most of the countries in the world

names(Data_Extra_by_Country)
```

```{r}
country_name_mapping_reverse <- c(
  'Belgium' = 'Bélgica',
  'Denmark' = 'Dinamarca',
  'Germany' = 'Alemania',
  'Greece' = 'Grecia',
  'Spain' = 'España',
  'France' = 'Francia',
  'Ireland' = 'Irlanda',
  'Italy' = 'Italia',
  'Luxembourg' = 'Luxemburgo',
  'Netherlands' = 'Países Bajos',
  'Portugal' = 'Portugal',
  'United Kingdom' = 'Reino Unido',
  'Austria' = 'Austria',
  'Sweden' = 'Suecia',
  'Finland' = 'Finlandia',
  'Cyprus' = 'República de Chipre',
  'Czech Republic' = 'República Checa',
  'Estonia' = 'Estonia',
  'Hungary' = 'Hungría',
  'Latvia' = 'Letonia',
  'Lithuania' = 'Lituania',
  'Malta' = 'Malta',
  'Poland' = 'Polonia',
  'Slovakia' = 'Eslovaquia',
  'Slovenia' = 'Eslovenia',
  'Bulgaria' = 'Bulgaria',
  'Romania' = 'Rumanía',
  'Croatia' = 'Croacia'
  # Note: 'Otros países' and 'DK' are specific to data_cleaning_2 and may not have direct mappings.
)


```

```{r}
Data_Extra_by_Country$country_name <- country_name_mapping_reverse[Data_Extra_by_Country$country_name]
```

Looking into the extra data set

```{r}
summary(Data_Extra_by_Country)
```

The variables chosen are the following:

```{r}
Data_Extra_by_Country <- Data_Extra_by_Country %>% 
  select(country_name,dir_crim,ind_crim,adp_general,trip_score,trip_percent)
```

```{r}
merged_df <- merge(data_cleaning_5, Data_Extra_by_Country, by = "country_name", all.x = TRUE)

```

## Descriptive Analysis

### First look at association

-   the descriptive analysis will oscillate between individual-level and country-level analysis

### Question

-   what to do with refusal ? = NA
-   what to do with don't know? = NA

### Gender

Assumption from literature –\> men less supportive than women

```{r}
df_descriptive <- merged_df

qc19labels <- c("Yes", "No", "Don't know")
names(qc19labels) <- c(1, 2, 3)

df_descriptive |>
  mutate(d10 = as.factor(d10),
         qc19_n = as.numeric(qc19),
         qc19 = as.factor(qc19)) |> 
  group_by(d10) |> 
  mutate(gsumqc19 = sum(qc19_n)) |> 
  ungroup() |> 
  group_by(qc19, d10) |> 
  mutate(gshare19 = (sum(qc19_n)/gsumqc19)*100) |> 
  ungroup() |> 
  ggplot(aes(x = qc19_multinominal, y = gshare19, fill = d10))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", gshare19))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  labs(title = "Do you think that transgender persons should be able to change\ntheir civil documents to match their inner gender identity?",
y = NULL,
x = NULL,
caption = "Source: Eurobarometer 91.4") +
  scale_fill_manual(labels = c("Men", "Women"), values = c("blue", "red")) +
  theme_minimal() +
  theme(legend.position = "bottom") +  # Adjust legend position
  guides(fill = guide_legend(title = NULL))  # Hide legend title


```

### Binary conception of gender

predictor of support of US sample

operationalization using question 20 on if there should be a third gender option

Table

```{r}
df_descriptive$qc20_multinominal <- factor(df_descriptive$qc20, levels = c(1, 2, 3),labels = c("Yes", "No", "Don't know"))

CrossTable(df_descriptive$qc19_multinominal, df_descriptive$qc20_multinominal, 
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Since the p-value is much smaller than the conventional significance level of 0.05, we reject the null hypothesis. This suggests that there is a significant association between the variables **`qc19`** and **`qc20`**.

Very high convergence of people against a third gender option and rejecting

88.29% of those against a third gender option also negate the option for transgender persons to change their gender in civil documents.

```{r}
plot_binary_1 <-
  df_descriptive |> 
  group_by(country_name) |> 
  summarise(share_no = mean(qc20 == 2, na.rm = TRUE)*100) |> 
  arrange(desc(share_no)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share_no)) +
  geom_col(fill = "red") +
  labs(x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share_no))),vjust = -0.5, size = 2)  +
  annotate("text", x = 9.5, y = 70, 
           label = "Share of 'No' responses to qc19:\nDo you think that transgender persons should be able to change\ntheir civil documents to match their inner gender identity?",
           hjust = 0, vjust = 0.5, size = 3, color = "black") +
  geom_rect(aes(xmin = 9.3, xmax = 24.3, 
                ymin = 62, ymax = 77),
                fill = "transparent", color = "black", linewidth = 1)

plot_binary_2 <- 
  df_descriptive |> 
  group_by(country_name) |> 
  summarise(share_no = mean(qc19 == 2, na.rm = TRUE)*100) |> 
  arrange(desc(share_no)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share_no)) +
  geom_col(fill = "red") +
  labs(x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 90, hjust= 0),
        plot.margin = margin(-10, 0, 0, 0)) +
  scale_x_discrete(position = "top") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share_no))), vjust = -0.5, size = 2)  +
  annotate("text", x = 10, y = 65, 
           label = "Share of 'No' responses to qc20:\nDo you believe that official documents, like passports and birth\ncertificates, should have a third option, such as X or O (other)\nbeside male (M) and female (F)for those persons who do not\nidentify as female and male?",
           hjust = 0, vjust = 0.5, size = 3, color = "black") +
  geom_rect(aes(xmin = 9.8, xmax = 24.6, 
                ymin = 53, ymax = 76),
                fill = "transparent", color = "black", linewidth = 1)
```

```{r}
#| echo: false
#| layout-ncol: 1

plot_binary_1
plot_binary_2
```

-   visually this high convergence can also be seen on the country level

-   to verify this statistically, the Spearman rank test is used as the country-level proportions are not normally distributed

-   the statistical association between agreeing there should be a third gender option and supporting the ability for transgender people to change their civil document on the country level is estimated

-   the Spearman rank test reports a very strong positive relationship between the two variables supporting the previous assertion that the acceptance of a third gender differentiates countries concerning their average approval of the civil document alteration for transgender people

```{r}

df_country_1 <- 
  df_descriptive |>
  group_by(country_name) |> 
  summarize(
    prop_gndr_bin = (sum(qc20_multinominal == "Yes") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_1$prop_gndr_bin, df_country_1$prop_qc19_yes, method = "spearman")
```

### Political ideology

```{r}
df_descriptive$d1_ordinal <- factor(df_descriptive$d1, levels = c(1, 2, 3, 4 , 5, 6, 7, 8, 9, 10, 97, 98),labels = c("Left", "2", "3", "4", "5", "6", "7", "8", "9", "Right", "Non-response", "Don't know"))

CrossTable(df_descriptive$d1_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Note:

-   25% of people chose 5, the exact middle ground

Surprising results:

-   The inherent idea is upheld that a greater share of more left-leaning people are in favor

-   However, difference to very right-leaning people is not that great (60-30 left vs. 43-45 right)

Problem:

-   self-reporting self-right scale might not be so accurate

-   a lot of information is hidden in the non-response and don't know groups of political ideology as they have greater don't know rates for qc19

Take-away

-   Still significant association (but maybe not as strong as suspected)

```{r}

df_descriptive |> 
  mutate(d1_bin = case_when(
    d1 < 4 ~ "Left",
    d1 < 8 ~ "Middle",
    d1 < 11 ~ "Right",
    TRUE ~ "DK/Refusal"
  )) |> 
  mutate(d1_bin = fct_relevel(d1_bin, "DK/Refusal", after = Inf)) |> 
  group_by(d1_bin, qc19_multinominal) |> 
  summarise(count = n()) |> 
  group_by(d1_bin) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = d1_bin, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by political ideology",
       x = "Political Ideology",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

#### Add government ideology as better proxy

### Religiosity

```{r}
df_descriptive <-
  df_descriptive |> 
  mutate(sd3_cat = case_when(sd3 == 1 ~ "Catholic",
                             sd3 == 2 ~ "Orthodox Christian",
                             sd3 == 3 ~ "Protestant",
                             sd3 == 4 ~ "Other Christian",
                             sd3 == 5 ~ "Jewish",
                             sd3 < 9 ~ "Muslim", 
                             sd3 < 12 ~ "Other",
                             sd3 < 14 ~ "Atheist | Agnostic",
                             sd3 == 14 ~ "Other",
                             sd3 > 14 ~ "Don't know | Refusal")) 

CrossTable(df_descriptive$sd3_cat, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

Problem:

-   Very low counts for Jewish, Muslim, Other and Other Christian as can be seen in the plot below

```{r}
df_descriptive |> 
  mutate(sd3_cat = fct_relevel(sd3_cat, "Don't know | Refusal", after = Inf)) |> 
  ggplot(aes(x = sd3_cat)) +
  geom_bar(fill = "black", color = "black", alpha = 0.5) +
  labs(title = "Frequency by religious affiliation",
       x = "",
       y = "Absolutec count",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Findings:

-   on the individual level not believing in God more say yes as well as Protestant

-   Catholics in favor but less strongly

-   Orthodox Christian strong outlier with being against it

Summary:

-   roughly one may say that countries with a higher share of Orthodox Christians may be rather against it

```{r}
df_descriptive |> 
  group_by(country_name) |> 
  summarise(share = mean(sd3_cat == "Orthodox Christian", na.rm = TRUE)*100) |> 
  arrange(desc(share)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share)) +
  geom_col(fill = "red") +
  labs(title = "Share of Orthodox Christians", 
       x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share))),vjust = -0.5, size = 2)
```

### Contact

```{r}
df_descriptive <-
  df_descriptive |> 
  mutate(
    sd1_7 = car::recode(sd1_7, "1=1; 2=0; 3=NA; 4=2"),
    sd1_7_multinomial = factor(sd1_7, levels = c(0, 1, 2), labels = c("No", "Yes", "Don't know"))
  )

CrossTable(df_descriptive$sd1_7_multinomial, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

-   association is statistically significant

-   the majority of people did not have contact with a transgender person

-   there is a clear tendency on the individual level that among those that have not had contact with a transgender person the approval is relatively lower as for those who have had the margin is very clear (76% vs 18%)

-   contact is associated rather with approval. Not having had contact not associated with being against, just lower approval

-   this is visualised below

```{r}
df_descriptive|> 
  drop_na(sd1_7_multinomial) |> 
  group_by(sd1_7_multinomial, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd1_7_multinomial) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd1_7_multinomial, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by previous conatct with transgender person",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Age

-   using anova to seek out differences between those who responded 'yes', 'no', don't know' by age

-   p-value let's us reject the null hypothesis. There is a statistically significant difference between at least two groups

```{r}
anova <- aov(d11 ~ qc19_multinominal, data = df_descriptive)
summary(anova)
```

-   visualizing group difference using boxplots

-   showing that the strongest difference is between those saying 'yes' and those stating 'don't know'

-   implies there is valuable information from particularly older people missing

```{r}
ggplot(df_descriptive, aes(x = qc19_multinominal, y = d11, fill = "red")) +
  geom_boxplot(color = "red") +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by age",
       y = "Age",
       x = "Support",
       caption = "Source: Eurobarometer 91.4") +
  theme(legend.position = "none")
```

-   regarding the difference between 'yes' and 'no' - those reporting the former are generally a bit younger

-   employ a correlation to look at strength and direction of the association while differentiating only between Yes and No

```{r}
df_cor_age <- 
  df_descriptive |> 
  select(qc19, d11) |> 
  filter(qc19 < 3) |> # filtering out everything besides 1 and 2
  mutate(qc19 = ifelse(qc19 == 2, 0, qc19)) # Assigning 2 the number 0 for logical interpretation

cor(df_cor_age$d11, df_cor_age$qc19)
```

-   as already implied above only a slight relation ship

-   negative direction shows that a one year increase in age decreases approval

### Awareness

-   if type of discrimination is widespread in own country

```{r}
df_descriptive$qc1_8_ordinal <- factor(df_descriptive$qc1_8, levels = c(1, 2, 3, 4 , 5, 6),labels = c("Very wide spread", "Fairly wide spread", "Fairly rare", "Very rare", "Nonexistent
", "DK"))

CrossTable(df_descriptive$qc1_8_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

-   p-value lets us very confidently state that there is a statistically significant relationship between the variables

-   among those reporting transgender people face very or fairly wide spread discrimination, the relative support for the possibility to change civil documents is greater than for those stating it is fairly rare, while among those reporting it is very rare the share between supporters and opponents is balanced

-   this clear association between more awareness and greater support is visible below

```{r}
df_descriptive|> 
  drop_na(qc1_8_ordinal) |> 
  group_by(qc1_8_ordinal, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(qc1_8_ordinal) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = qc1_8_ordinal, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

-   between countries

-   countries which have a higher share of approval are to be found rather towards the

```{r}
df_descriptive |> 
  mutate(qc1_8_ordinal = case_when(
    qc1_8_ordinal == "Very wide spread" ~ "Very or fairly wide spread",
    qc1_8_ordinal == "Fairly wide spread" ~ "Very or fairly wide spread",
    TRUE ~ qc1_8_ordinal
  )) |>
  group_by(country_name) |> 
  summarise(share = mean(qc1_8_ordinal == "Very or fairly wide spread", na.rm = TRUE)*100) |> 
  arrange(desc(share)) |> 
  mutate(country_name = factor(country_name, levels = country_name)) |>
  filter(country_name != "Otros países") |> 
ggplot(aes(x = country_name, y = share)) +
  geom_col(fill = "red") +
  labs(title = "Share of respondents perceiving discrimination against transgender people\nto be very of fairly wide spread", 
       x = "",
       y = "",
       caption = "Source: Eurobarometer 91.4") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin = margin(0, 0, 0, 0))  +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_text((aes(label = sprintf("%.1f%%", share))),vjust = -0.5, size = 2)
```

-   to further investigate the country-level differences the association of the proportion of individuals aware of discrimination per country and the proportion of individuals in favor of the ability of transgender people to change their civil documents

-   because the variables are non-normally distributed, we use the Spearman rank test

```{r}
df_country_2 <-
  df_descriptive |> 
  mutate(qc1_8_ordinal = case_when(
    qc1_8_ordinal == "Very wide spread" ~ "Very or fairly wide spread",
    qc1_8_ordinal == "Fairly wide spread" ~ "Very or fairly wide spread",
    TRUE ~ qc1_8_ordinal
  )) |> 
  group_by(country_name) |> 
  summarize(
    prop_dis_wide = (sum(qc1_8_ordinal == "Very or fairly wide spread") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_2$prop_dis_wide, df_country_2$prop_qc19_yes, method = "spearman")
```

-   the test shows a strong relationship between awareness of discrimination faced by transgender people on the country-level insuating that in countries with greater awareness there is greater support

### Solidarity among minority groups

```{r}
df_descriptive <- 
  df_descriptive |>  
  mutate(
    sd2t = factor(sd2t, levels = c(0, 1), labels = c("Not mentioned", "Yes"))
  )
```

As the subsequent plot demonstrates, there is no general solidarity among minority group expressed by a greater support for transgender people than among individuals without any minority-background.

```{r}
df_descriptive|> 
  drop_na(sd2t) |> 
  group_by(sd2t, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd2t) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd2t, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

However, this support is much greater among people who themselves are a sexual minority. As such, people with similar experiences as transgender people are more likely to support transgender rights.

```{r}
df_descriptive <- 
  df_descriptive |>  
  mutate(
    sd2_5 = factor(sd2_5, levels = c(0, 1), labels = c("Not mentioned", "Yes"))
  )


df_descriptive|> 
  drop_na(sd2_5) |> 
  group_by(sd2_5, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(sd2_5) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = sd2_5, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by perceived discrimination transgender people face",
       x = "Contact",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Education

-   age when leaving formal education

-   expected that higher and lower ages are outliers

-   one is able to gauge differences between the 'yes' and 'no' respondents with the former reporting a slightly higher age as their mode (highest frequency)

```{r}
df_descriptive <- 
  df_descriptive |> 
  mutate(d8 = case_when(d8 < 98 ~ d8,
                        TRUE ~ NA)) # turning don't know and refusal into NA to keep continuous character of the variable - imputed later


ggplot(df_descriptive, aes(x = qc19_multinominal, y = d8, fill = "red")) +
  geom_boxplot(color = "red") +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by age",
       y = "Age when leaving formal education",
       x = "Support",
       caption = "Source: Eurobarometer 91.4") +
  theme(legend.position = "none")

```

The ANOVA analysis supports the claim, at least, that the groups are statistically significantly different from one another.

```{r}
anova <- aov(d8 ~ qc19_multinominal, data = df_descriptive)
summary(anova)
```

```{r}
df_cor_age <- 
  df_descriptive |> 
  select(qc19, d8) |> 
  filter(qc19 < 3) |> # filtering out everything besides 1 and 2
  mutate(qc19 = ifelse(qc19 == 2, 0, qc19)) # Assigning 2 the number 0 for logical interpretation

cor(df_cor_age$d8, df_cor_age$qc19)
```

The correlation shows there is a very weak association in favor of the literature's case that being more educated is associated with an increased support of transgender rights.

### The economic situation

-   During the last twelve months, would you say you had difficulties to pay your bills at the end of the month…?

```{r}

df_descriptive <- 
  df_descriptive |> 
  mutate(
    d60 = car::recode(d60, "4=NA"),
    d60_ordinal = factor(d60, levels = c(1, 2, 3), labels = c("Most of the time", "From time to time", "Almost never/ never"))
  )

CrossTable(df_descriptive$d60_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

-   following the literature, among those who never or almost never had difficulties to pay their bills at the end of the month, the support for the possibility of transgender people to alter their gender in their civic documents is markedly higher.

-   the low p-value indicates that the association is statistically significant

-   confers with literature

-   this difference is visualized by the graph below

```{r}
df_descriptive|> 
  drop_na(d60_ordinal) |> 
  group_by(d60_ordinal, qc19_multinominal) |> 
  summarise(count = n()) |> 
  ungroup() |> 
  group_by(d60_ordinal) |> 
  mutate(share = count / sum(count) * 100) |>
  ungroup() |> 
  ggplot(aes(x = d60_ordinal, y = share, fill = qc19_multinominal))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_text((aes(label = sprintf("%.1f%%", share))), position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  theme_minimal() +
  labs(title = "Support of change of gender in civil documents for transgender\npeople by times having difficulties to pay the bills in last 12 months",
       x = "Having difficulties to pay the bills in last 12 months",
       y = "",
       caption = "Source: Eurobarometer 91.4")+
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Dark2")
```

### Support for LGBT rights

```{r}
df_descriptive <- 
  df_descriptive |> 
  mutate(
    qc15_1_ordinal = factor(qc15_1, levels = c(1, 2, 3, 4, 5), labels = c("Totally agree", "Tend to agree", "Tend to disagree", "Totally disagree", "Don't know"))
  )

CrossTable(df_descriptive$qc15_1_ordinal, df_descriptive$qc19_multinominal,
           digits=2, 
           expected=F, 
           asresid=T, 
           chisq=TRUE, 
           prop.chisq=F, 
           format="SPSS")
```

-   the p-value indicates statistical significance concerning the association between the two variables

-   as may be expected, among those disagreeing that people part of the LGB community should have equal rights the support is very low and the rejection of the possibility

-   rejection is almost as pronounced as the support regarding transgender people's ability to change their gender identification of those who totally agree people of the LGB community should have the same rights

-   important: two way association

-   on the country level

```{r}
df_country_3 <- 
  df_descriptive |>
  mutate(qc15_1_ordinal = case_when(
    qc15_1_ordinal == "Totally agree" ~ "Totally or tend to agree",
    qc15_1_ordinal == "Tend to agree" ~ "Totally or tend to agree",
    TRUE ~ qc15_1_ordinal
  )) |> 
  group_by(country_name) |> 
  summarize(
    prop_lgb_yes = (sum(qc15_1_ordinal == "Totally or tend to agree") / n())*100, # Calculate proportion with high education
    prop_qc19_yes = (sum(qc19 == 1) / n())*100)


cor(df_country_3$prop_lgb_yes, df_country_3$prop_qc19_yes, method = "spearman")
```

-   very strong association on the country level indicating that most likely countries where there is greater support for the legal equality for LGB people also post higher support rates for the adoption of legislation allowing transgender people to change their gender in civic documents

-   this only captures the support direction. As outlined above, a similar strength may be expected for the revers association.

### Legal Criminalization of LGBTQ community by country level

# Correlation between the significant numeric variables

```{r}
corr_data <- data_cleaning_5 |> 
  select(-non_significant_vars) |> 
  select(-c(qa4t_1:qa6_8)) |> 
  mutate_if(is.character, as.numeric) # because the correlation matrix can only be calculated with numeric data, but this creates many NAs which need to be imputed

target_columns <- c("qc19") # we pick 2 target variables because we are interested to see the correlation of th

# Check for NA values in the data
na_summary <- colSums(is.na(corr_data))

# Print columns with NA values
cols_with_na <- names(na_summary[na_summary > 0])
print(cols_with_na)

# Convert target_columns to numeric
corr_data[target_columns] <- lapply(corr_data[target_columns], as.numeric)

# Filter out rows with missing values in target columns
corr_data <- corr_data[complete.cases(corr_data[target_columns]), ]

#defining columns that will work for the correlation matrix
numeric_cols <- corr_data[corr_data]

# Determine the number of columns in complete_data
num_cols <- ncol(corr_data)

# Calculate the number of columns in each subset (assuming you want approximately equal splits)
subset_size <- ceiling(num_cols / 6)

# Split complete_data into three subsets
subset_1 <- numeric_cols[, 1:subset_size]
subset_2 <- numeric_cols[, (subset_size + 1):(2 * subset_size)]
subset_3 <- numeric_cols[, (2 * subset_size + 1):(3 * subset_size)]
subset_4 <- numeric_cols[, (3 * subset_size + 1):(4 * subset_size)]
subset_5 <- numeric_cols[, (4 * subset_size + 1):(5 * subset_size)]
subset_6 <- numeric_cols[, (5 * subset_size + 1):num_cols]

#1
cor_matrix1 <- cor(corr_data[target_columns], subset_1, use = "pairwise.complete.obs")
corr1 <- corrplot(cor_matrix1, method = "circle", tl.col = "black", tl.srt = 45)

#2
cor_matrix2 <- cor(complete_data[target_columns], subset_2, use = "pairwise.complete.obs")
corr2 <- corrplot(cor_matrix2, method = "circle", tl.col = "black", tl.srt = 45)

#3
cor_matrix3 <- cor(complete_data[target_columns], subset_3, use = "pairwise.complete.obs")
corr3 <- corrplot(cor_matrix3, method = "circle", tl.col = "black", tl.srt = 45)

#4
cor_matrix4 <- cor(complete_data[target_columns], subset_4, use = "pairwise.complete.obs")
corr4 <- corrplot(cor_matrix4, method = "circle", tl.col = "black", tl.srt = 45)

#5
cor_matrix5 <- cor(complete_data[target_columns], subset_5, use = "pairwise.complete.obs")
corr5 <- corrplot(cor_matrix5, method = "circle", tl.col = "black", tl.srt = 45)

#6
cor_matrix6 <- cor(complete_data[target_columns], subset_6, use = "pairwise.complete.obs")
corr6 <- corrplot(cor_matrix6, method = "circle", tl.col = "black", tl.srt = 45)
```

```{r}
complete_data <- data_cleaning_5 %>%
  select(all_of(significant_vars)) 

# Recalculate num_cols because it's just an integer, not data
num_cols <- ncol(complete_data)

# Calculate the number of columns in each subset (for approximately equal splits)
subset_size <- ceiling(num_cols / 6)

# Correctly create subsets based on columns
subset_1 <- complete_data[, 1:subset_size]
subset_2 <- complete_data[, (subset_size + 1):(2 * subset_size)]
subset_3 <- complete_data[, (2 * subset_size + 1):(3 * subset_size)]
subset_4 <- complete_data[, (3 * subset_size + 1):(4 * subset_size)]
subset_5 <- complete_data[, (4 * subset_size + 1):(5 * subset_size)]
subset_6 <- complete_data[, (5 * subset_size + 1):num_cols]


#1
cor_matrix1 <- cor(subset_1)
corrplot(cor_matrix1, method = "circle", tl.col = "black", tl.srt = 45)

#2
cor_matrix2 <- cor(subset_2)
corrplot(cor_matrix2, method = "circle", tl.col = "black", tl.srt = 45)

#3
cor_matrix3 <- cor(subset_3)
corr3 <- corrplot(cor_matrix3, method = "circle", tl.col = "black", tl.srt = 45)

#4
cor_matrix4 <- cor(subset_4)
corr4 <- corrplot(cor_matrix4, method = "circle", tl.col = "black", tl.srt = 45)

#5
cor_matrix5 <- cor(subset_5)
corr5 <- corrplot(cor_matrix5, method = "circle", tl.col = "black", tl.srt = 45)

#6
cor_matrix6 <- cor(subset_6)
corr6 <- corrplot(cor_matrix6, method = "circle", tl.col = "black", tl.srt = 45)
```

According to the matrix, we see that the variables;

variables starting with qc6\_ with each other,

variables starting with qc12\_ with each other,

variables starting with qc13\_ with each other,

variables starting with qc15\_ with each other,

d62_3, D62t, netuse with each other.

Here we see many columns with NA values, especially towards the end.

```{r}
# Check for NA values in the data
na_summary <- colSums(is.na(complete_data))
 
# Print columns with NA values
cols_with_na_names <- names(na_summary[na_summary > 0])
cols_with_na <- na_summary[na_summary > 0]
print(cols_with_na)

```

impute using fixed effects, use a vector to include the factor country

multilevel analysis on the countries, join with country level data

So let's impute the missing data. Random Forest method of imputation should be the most accurate for imputing data with both continuous variables and categorical variables.

```{r}
library(mice)
library(missForest)

# Define the number of imputations
num_imputations <- 5  # Adjust as needed

# Perform multiple imputation using polyreg method
imputed_data <- mice(complete_data, method = "polyreg", m = num_imputations)

# Get the completed datasets
imputed_datasets <- complete(imputed_data)

# Subset the dataset to include only the variables with warnings
vars_with_warnings <- c("d40_d11", "p7ro", "p6ro", "d15b", "p7", "p7gr_r", "p7ie", "p7gr", "p7pl_r", "p7fi", "p6si", "p6fi", "p7lv", "p6hr", "p6lt", "p7cy", "p7hu_r", "p7pt", "p7sk", "d15b_r", "p6mt", "p7pl", "p7be_r", "p6lv", "p7ro_r", "p7ee", "p6hu", "p7lt", "p7it_r2", "p7it", "p13", "p6sk", "p6cy", "p6de", "p7de", "p7it_r1", "p7es", "p7hu", "p6fr", "p7be", "p7se_r")
subset_data <- complete_data[vars_with_warnings]

# Check the structure of the subsetted dataset
str(subset_data)

# Perform multiple imputation using polyreg method
imputed_data <- mice(subset_data, method = "polyreg", m = num_imputations)

# Get the completed datasets
imputed_datasets <- complete(imputed_data)
```
